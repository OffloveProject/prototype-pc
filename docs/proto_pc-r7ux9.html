<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Offstage Love â€“ Mini Proto</title>
<link rel="stylesheet" href="style_pc.css" />

<!-- PCç”¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¿½åŠ  -->   <link rel="stylesheet" href="style_pc_large.css" />

<meta name="robots" content="noindex,nofollow">
</head>
<body>
<div class="app">
  <header>Offstage Love â€“ Mini Proto</header>

<!-- Splash (catch copy) -->
<div id="splash" class="splash">
  <div class="splash-inner">éŸ³ã§ã€æ‹ã™ã‚‹ã€‚</div>
</div>

<!-- Start Screen (tap to enter) â†“â†“â†“ã“ã“ã‹ã‚‰-->
<div id="start-screen" class="start-screen">
  <div class="sky">
    <div class="stars"></div>
    <div class="twinkle"></div>
    <div class="aurora"></div>
  </div>

  <div class="notes" id="notes-layer" aria-hidden="true"></div>

  <div class="start-inner">
      <div class="romantic-title">
        <div class="start-title">Offstage Love</div>
        <div class="start-sub">ç§˜å¯†ã®æ‹ã¨å¤¢ã®ã¯ã–ã¾ã§</div>
        <div id="tap-to-start" class="tap">Click to Start</div>
        <div class="hint">press any key</div>
    </div>
    </div>
</div>
<!-- Start Screen (tap to enter) â†‘â†‘â†‘ã“ã“ã¾ã§-->

  <!-- ===== Title ===== -->
  <main id="page-title">
    <div class="phone-viewport">   <!-- è¿½åŠ ï¼ˆé–‹ãï¼‰ -->
      <div id="title-bg" class="title-bg"></div>  <!-- â† è¿½åŠ ï¼ˆèƒŒæ™¯ãƒ©ãƒ³ãƒ€ãƒ åˆ‡æ›¿ç”¨ï¼‰ -->
        <div class="card title-card title-line" style="text-align:center; padding:0px;">
          <div class="logo-glow"></div>
          <img src="assets/title/logo/offstagelove_logo_1.png" alt="Offstage Love" class="logo-img">
          <div class="logo-ribbon"></div>
          <div class="version" style="margin:0px;"><em>Prototype</em></div>
        </div>

        <button id="btn-continue" class="btn title-line">Continue</button>
        <button id="btn-new" class="btn title-line">New Game</button>

        <!-- Album row -->
        <div class="row title-line">
          <button id="btn-album" class="btn">ğŸ“¸Album</button>
        </div>

        <div class="row title-line">
          <button id="btn-settings" class="btn title-btn-ghost" title="Settings">âš™<br><span>Settings</span></button>
          <button id="btn-about" class="btn title-btn-ghost" title="About & Legal">â„¹ï¸<br><span>About</span></button>
          <button id="btn-tracks" class="btn title-btn-ghost" title="Musics">ğŸµ<br><span>Musics</span></button>
          <button style="display:none;" id="btn-nft" class="btn title-btn-ghost" title="NFT">ğŸª™<br><span>NFT</span></button>
          <!-- PCç‰ˆã§ã¯btn-nft ã¯è¡¨ç¤ºã—ãªã„ã€‚è¡¨ç¤ºã•ã›ã‚‹å ´åˆã¯ã€Œstyle="display:none;"ã€ã‚’å‰Šé™¤ -->
        </div>

        <!-- Quick Actions: ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ / æ©Ÿç¨®å¤‰æ›´ / ãŠå•ã„åˆã‚ã› -->
          <div class="quick-actions title-line" id="quick-actions">
            <button id="qa-shop"     class="qa-btn">ğŸ’ ãƒã‚¤ãƒ³ãƒˆè³¼å…¥</button>
            <button id="qa-transfer" class="qa-btn">ğŸ” æ©Ÿç¨®å¤‰æ›´</button>
            <button id="qa-contact"  class="qa-btn">âœ‰ ãŠå•ã„åˆã‚ã›</button>
          </div>

        <!-- Title ã®ä¸‹éƒ¨è£…é£¾ -->
        <div id="title-footer-deco" class="title-footer-deco"></div>

          <!-- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç”¨ â€œå…±é€šâ€ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
          <div id="qa-modal" class="modal hidden" aria-hidden="true" style="position:fixed;">
            <div class="modal-card">
              <h3 id="qa-title" class="modal-title">æº–å‚™ä¸­</h3>
              <div id="qa-body"  class="modal-body">
                â€»ã“ã®æ©Ÿèƒ½ã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ã‚¬ãƒ¯ã®ã¿ã§ã™ã€‚
              </div>
              <div class="row" style="margin-top:12px;">
                <button id="qa-close" class="btn" style="width:100%;">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          </div>


        <div class="card">
          <div style="margin:0 0 6px 0; font-weight:700;">Paste <code>script_json</code> hereã€€â€»ãƒ—ãƒ­ãƒˆç‰ˆã®ã¿</div>
          <textarea id="script-input"></textarea>
          <div class="row">
            <button id="btn-load" class="btn">Load</button>
            <button id="btn-fill" class="btn">Fill sample</button>
          </div>
          <div id="load-msg" class="subtitle"></div>
          <div class="subtitle">ä¿å­˜ã‚­ãƒ¼: <span class="mono">localStorage["offlove_save_v1"]</span></div>
        </div>
    </div>    <!-- è¿½åŠ ï¼ˆé–‰ã˜ã‚‹ï¼‰ -->
  </main>

  <!-- ======== ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ã“ã“ã‹ã‚‰ ======== -->

  <!-- ===== Log (Backlog) ===== -->
  <div id="log-modal" class="modal hidden">
    <div class="modal-card">
      <h3 style="margin-top:0;">Backlog</h3>
      <div id="log-list" class="list" style="max-height:50vh; overflow:auto;"></div>
      <div class="row" style="margin-top:12px;">
        <button id="btn-log-close" class="btn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ===== Album (Seen Stills) ===== -->
  <div id="album-modal" class="modal hidden">
    <div class="modal-card">
      <h3 style="margin-top:0;">Album</h3>
      <div id="album-list" class="list" style="max-height:50vh; overflow:auto;"></div>
      <div class="row" style="margin-top:12px;">
        <button id="btn-album-close" class="btn">é–‰ã˜ã‚‹</button>
      </div>
      <div class="subtitle">â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼šè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ«ã®ä¸€è¦§ï¼ˆç¸®å°ç”»åƒã¯çœç•¥ï¼‰</div>
    </div>
  </div>

  <!-- ===== Settings ===== -->
  <main id="page-settings" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Settings</h2>
      <div class="form">
        <label>ä¸»äººå…¬ã®åå­—</label>
        <input id="inp-family" type="text" inputmode="text" />
        <label>ä¸»äººå…¬ã®åå‰</label>
        <input id="inp-given" type="text" inputmode="text" />
        <div class="subtitle">â€»åˆæœŸå€¤ï¼šæ©˜ èŒé¦™ï¼ˆã‚ã¨ã§ã„ã¤ã§ã‚‚å¤‰æ›´å¯èƒ½ï¼‰</div>

        <label>æ–‡å­—ã‚µã‚¤ã‚º</label>
          <select id="sel-fontsize">
            <option value="s">å° (S)</option>
            <option value="m" selected>æ¨™æº– (M)</option>
            <option value="l">å¤§ (L)</option>
            <option value="xl">ç‰¹å¤§ (XL)</option>
          </select>

          <!-- â–¼ ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯/è‡ªå‹•ï¼‰ -->
          <label>ãƒ†ãƒ¼ãƒ</label>
          <select id="sel-theme">
            <option value="auto">è‡ªå‹•ï¼ˆOSè¨­å®šã«è¿½å¾“ï¼‰</option>
            <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
            <option value="light">ãƒ©ã‚¤ãƒˆ</option>
          </select>

          <!-- â–¼ ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ”ãƒ¼ãƒ‰ -->
          <label>ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ”ãƒ¼ãƒ‰</label>
          <select id="sel-textspeed">
            <option value="instant">å³æ™‚</option>
            <option value="normal" selected>ãµã¤ã†</option>
            <option value="slow">ã‚†ã£ãã‚Š</option>
          </select>

      </div>
      <div class="row">
        <button id="btn-cancel-settings" class="btn btn-ghost">æˆ»ã‚‹</button>
        <button id="btn-save-settings" class="btn">ä¿å­˜</button>
      </div>
    </div>
  </main>

  <!-- ===== Scene ===== -->
  <main id="page-scene" class="hidden">
    <div class="scene">

       <!-- å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button id="btn-menu" class="menu-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â‰¡</button>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="mainmenu-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Main Menu</h3>
            <div class="list">
              <button id="mnu-status" class="btn">Status</button>
              <button id="mnu-save"   class="btn">Save</button>
              <button id="mnu-load"   class="btn">Load</button>
              <button id="mnu-log"    class="btn">Log</button>
              <button id="mnu-opt"    class="btn">Option</button>
              <button id="mnu-help"   class="btn">Help</button>
              <button id="mnu-title"  class="btn">Title</button>
            </div>
            <div class="row" style="margin-top:12px;">
              <button id="btn-menu-close" class="btn">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        </div>

        <!-- Status -->
        <div id="status-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Status</h3>
            <div id="status-body"></div>
            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="el('status-modal').classList.add('hidden')">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        </div>


        <!-- Optionï¼ˆç’°å¢ƒè¨­å®šã‚¬ãƒ¯ï¼‰ -->
        <div id="option-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Option</h3>
            <div class="form">
              <label>ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ”ãƒ¼ãƒ‰</label>
              <select id="opt-type">
                <option value="instant">å³æ™‚</option>
                <option value="normal" selected>ãµã¤ã†</option>
                <option value="slow">ã‚†ã£ãã‚Š</option>
              </select>
              <label>BGMéŸ³é‡</label><input type="range" min="0" max="5" value="3">
              <label>ãƒœã‚¤ã‚¹éŸ³é‡</label><input type="range" min="0" max="5" value="3">
              <label>SEéŸ³é‡</label><input type="range" min="0" max="5" value="3">
              <!-- ã€Œ<input type="range" min="0" max="5" value="3" disabled>ã€ãªã‚‰disabledã«ã§ãã‚‹ -->
              â€»ãƒ—ãƒ­ãƒˆç‰ˆã®éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯ã‚¬ãƒ¯ã®ã¿
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn btn-ghost" onclick="el('option-modal').classList.add('hidden')">æˆ»ã‚‹</button>
              <button id="btn-option-save" class="btn">ä¿å­˜</button>
            </div>
          </div>
        </div>

        <!-- Helpï¼ˆé™çš„ï¼‰ -->
        <div id="help-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Help</h3>
            <div class="list">
              <div class="list-item"><strong>â—€ï¸ï¼š</strong><span class="meta">å‰ã®ã‚·ãƒ¼ãƒ³ã¸æˆ»ã‚‹</span></div>
              <div class="list-item"><strong>ç”»é¢ã‚¿ãƒƒãƒ—ã€ã¾ãŸã¯ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ï¼š</strong><span class="meta">æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¸é€²ã‚€</span></div>
              <div class="list-item"><strong>â©æ—©é€ã‚Šï¼š</strong><span class="meta">æŠ¼ã—ã¦ã„ã‚‹é–“ã¯ãƒ†ã‚­ã‚¹ãƒˆä¸€æ‹¬è¡¨ç¤ºï¼ˆãƒ—ãƒ­ãƒˆç‰ˆã§ã¯ã‚¬ãƒ¯ã®ã¿ï¼‰</span></div>
              <div class="list-item"><strong>â–¶ï¸AUTOï¼š</strong><span class="meta">è‡ªå‹•ã§é€²è¡Œ</span></div>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="el('help-modal').classList.add('hidden')">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        </div>


        <!-- ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="home-confirm" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</h3>
            <p class="subtitle">é€²è¡ŒçŠ¶æ³ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼ˆãƒ—ãƒ­ãƒˆç‰ˆã¯ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–æœªå®Ÿè£…ï¼‰</p>
            <div class="row" style="margin-top:12px;">
              <button id="btn-home-no"  class="btn btn-ghost">ã„ã„ãˆ</button>
              <button id="btn-home-yes" class="btn">ã¯ã„</button>
            </div>
          </div>
        </div>

       <div id="bg" class="bg"></div>
      <div class="char"><img id="char-img" alt=""></div>

      <div id="hud" class="hud">
        <div id="aff-debug"></div> <!-- ãƒ‡ãƒãƒƒã‚°ç”¨å¥½æ„Ÿåº¦è¡¨ç¤º -->
      </div>

      <div class="textbox">
          <div id="name" class="name"></div>
          <div id="text" class="text"></div>
          <div id="choices" class="choice hidden"></div>
          <button id="btn-backline" class="btn-mini">â—€ï¸</button>
          <button id="btn-confirm" class="btn-confirm hidden" disabled>æ±ºå®š</button>
          <div class="nav-mini">
            <button id="btn-ff"   class="btn-mini" title="æ—©é€ã‚Š(ãƒ—ãƒ­ãƒˆç‰ˆã¯ã‚¬ãƒ¯ã®ã¿)">â©</button>
            <button id="btn-auto" class="btn-mini" title="AUTO">â–¶ï¸</button>
            <button id="btn-go"   class="btn-mini" title="æ¬¡ã¸">â¡ï¸</button>
          </div>
        </div>
    </div>
  </main>

  <!-- ===== Result ===== -->
  <main id="page-result" class="hidden">
  <div class="card result-card">
    <div id="result-title" class="result-title">çµæœã€â€¦ã€‘</div>
    <div id="result-text"  class="result-text">â€¦â€¦</div>
  </div>

  <div class="card">
    <div class="result-label">ã‚ãªãŸãŒå‘Šç™½ã—ãŸç›¸æ‰‹</div>
    <div id="result-target" class="result-target">â€”</div>
  </div>

  <div class="card">
    <div class="result-label">å¥½æ„Ÿåº¦ä¸€è¦§</div>
    <div id="result-aff-list" class="result-aff">
      <!-- ä¾‹ï¼‰
      é™½ç¿”:0
      å¸:2
      -->
    </div>
  </div>

  <button id="btn-back" class="btn">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
</main>

</div>

<!-- ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼â†“â†“â†“ã“ã“ã‹ã‚‰ -->

        <!-- Save -->
        <div id="save-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Save</h3>ã‚»ãƒ¼ãƒ–ã™ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

              <div id="save-list" class="list"></div>
              <div class="row" style="margin-top:12px;">
                <button class="btn" onclick="el('save-modal').classList.add('hidden')">é–‰ã˜ã‚‹</button>
              </div>
          </div>
        </div>

        <!-- Load -->
        <div id="load-modal" class="modal hidden">
          <div class="modal-card">
            <h3 style="margin-top:0;">Load</h3>ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

            <div id="load-list" class="list"></div>
            <div class="row" style="margin-top:12px;">
              <button class="btn" onclick="el('load-modal').classList.add('hidden')">é–‰ã˜ã‚‹</button>
             </div>
          </div>
        </div>

<!-- ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼â†‘â†‘â†‘ã“ã“ã¾ã§ -->


<!-- ã€ŒAbout/Legalã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->

<div id="about-modal" class="modal hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;">About & Legal</h3>
    <div class="modal-body">
      <div class="subtitle" id="app-version">Version: v0.1.0 (Demo)</div>
      <hr/>
      <p><strong>ä½œå“åï¼š</strong>Offstage Loveã€€ã€œç§˜å¯†ã®æ‹ã¨å¤¢ã®ã¯ã–ã¾ã§ã€œ</p>
      <p><strong>é–‹ç™ºï¼š</strong>Offstage Love Project</p>
      <p><strong>é€£çµ¡å…ˆï¼š</strong><a href="mailto:info@offstagelove.com">info@offstagelove.com</a></p>
      <p><strong>å…¬å¼ã‚µã‚¤ãƒˆï¼š</strong>
        <a href="https://offstagelove.com" target="_blank" rel="noopener">
          https://offstagelove.com
        </a>
      </p>
      <hr/>
      <p><strong>ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ï¼š</strong>æœ¬ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® <code>localStorage</code> ã®ã¿ã‚’ä½¿ç”¨ã—ã€å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒã«é€ä¿¡ã—ã¾ã›ã‚“ã€‚</p>
      <p class="subtitle">â€»Analyticsç­‰ã‚’å°å…¥ã™ã‚‹å ´åˆã¯ã€ãã®æ—¨ã¨ç›®çš„ãƒ»å–å¾—é …ç›®ãƒ»ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆæ–¹æ³•ã‚’ã“ã“ã«æ˜è¨˜ï¼ˆç¾åœ¨ã¯æœªå°å…¥ï¼‰</p>
      <hr/>
      <p><a id="link-privacy" href="https://offstagelove.com/app/privacypolicy.html" target="_blank" rel="noopener">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></p>
      <p><a id="link-tos" href="https://offstagelove.com/app/termsofservice.html" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„</a></p>
      <div class="row" style="margin-top:12px;">
        <button id="btn-about-close" class="btn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- æ¥½æ›²ãƒªã‚¹ãƒˆâ†“â†“â†“ã“ã“ã‹ã‚‰ -->
<div id="tracks-modal" class="modal hidden">
  <div class="modal-card tracks-card">
    <h3 style="margin-top:0;">æ¥½æ›²ãƒªã‚¹ãƒˆ</h3>

    <!-- ä¸Šéƒ¨ï¼šã‚¸ãƒ£ã‚±ãƒƒãƒˆé¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="tracks-header">
      <div class="tracks-cover"></div>
      <div class="tracks-meta">
        <div class="tracks-title-main">Offstage Love â€“ Original Tracks</div>
        <div class="tracks-sub">â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ã‚¬ãƒ¯ã®ã¿</div>
      </div>
    </div>

    <!-- æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ ï¼‹ æ›²ç•ªå·ï¼ˆè‡ªå‹•æ¡ç•ªï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰ -->
    <div class="tracks-player">
      <div class="tracks-player-text">
        <div id="np-title" class="np-title">Value of Stars</div>
        <div id="np-artist" class="np-artist">CELEST</div>
      </div>

      <div class="tracks-player-seek">
        <span id="np-time-current" class="np-time np-time-current">0:00</span>
        <input id="np-seek" type="range" min="0" max="100" value="0">
        <span id="np-time-total" class="np-time np-time-total">3:08</span>
      </div>

      <div class="tracks-player-controls">
        <button id="np-prev"  class="np-btn" aria-label="å‰ã®æ›²ã¸">âª</button>
        <button id="np-toggle" class="np-btn np-btn-main" aria-label="å†ç”Ÿï¼ä¸€æ™‚åœæ­¢">âšâš</button>
        <button id="np-next"  class="np-btn" aria-label="æ¬¡ã®æ›²ã¸">â©</button>

        <div class="np-volume">
          <span class="np-vol-icon">ğŸ”Š</span>
          <input id="np-volume" type="range" min="0" max="100" value="30">
        </div>
      </div>
    </div>
    <!-- æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ ï¼‹ æ›²ç•ªå·ï¼ˆè‡ªå‹•æ¡ç•ªï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§ -->

    <!-- ãƒ¡ã‚¤ãƒ³å†ç”Ÿãƒ»å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
    <div class="tracks-main-controls">
      <div class="trk-mode-buttons">

        <!-- <button class="trk-mode-btn" data-mode="normal">â–¶ å†ç”Ÿ</button> -->
        <button class="trk-mode-btn" data-mode="shuffle">ğŸ”€Shuffle</button>
        <button class="trk-mode-btn" data-mode="one">ğŸ”Repeat One</button>
        <button class="trk-mode-btn" data-mode="all">ğŸ”‚Repeat All</button>
      </div>
    </div>

    <!-- æ¥½æ›²ãƒªã‚¹ãƒˆæœ¬ä½“ -->
    <div id="tracks-list" class="tracks-list"></div>

    <div class="row" style="margin-top:16px;">
      <button id="btn-tracks-close" class="btn" style="width:100%;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>
<!-- æ¥½æ›²ãƒªã‚¹ãƒˆâ†‘â†‘â†‘ã“ã“ã¾ã§ -->

<!-- NFT -->
<div id="nft-modal" class="modal hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;">NFT</h3>
    <p class="subtitle">â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ã‚¬ãƒ¯ã®ã¿ã€‚<br>â€»æœ¬ç•ªç”¨ã§ã¯OpenSeaé€£æºã§æ‰€æœ‰NFTã‚’è¡¨ç¤º<br>ï¼ˆæœ¬ã‚¢ãƒ—ãƒªå†…ã«ã¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ©Ÿèƒ½ã‚’æ­è¼‰ã›ãšã€é–²è¦§ã®ã¿å¯èƒ½ï¼‰</p>
    <div class="card" style="margin-top:8px;">
      <p><strong>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼š</strong><span id="nft-collection-name">Offstage Love â€“ CELEST Cards</span></p>
      <p><strong>å…¬é–‹URLï¼š</strong><a id="nft-link" style="pointer-events: none;" href="#" target="_blank" rel="noopener">æº–å‚™ä¸­</a></p>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btn-nft-close" class="btn">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- Start Character Select (debug only) -->
<div id="start-modal" class="modal hidden">
  <div class="modal-card">
    <h3 style="margin-top:0;">é–‹å§‹ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</h3>
    <div class="row" style="margin-top:8px; gap:8px;">
      <button id="btn-start-haruto" class="btn">é™½ç¿”ã‹ã‚‰å§‹ã‚ã‚‹</button>
      <button id="btn-start-tsukasa" class="btn">å¸ã‹ã‚‰å§‹ã‚ã‚‹</button>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btn-start-cancel" class="btn btn-ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="subtitle">â€»æœ¬ç•ªã§ã¯ã“ã®é¸æŠã¯è¡¨ç¤ºã—ã¾ã›ã‚“ï¼ˆç¢ºèªç”¨ï¼‰</div>
  </div>
</div>

        <!-- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç«‹ã¡ä¸Šã’å›é¿ç­–ï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰ -->
        <div id="sys-confirm" class="modal hidden">
          <div class="modal-card">
            <p id="sys-confirm-message" style="margin-top:0;"></p>
            <div class="row" style="margin-top:12px;">
              <button id="sys-confirm-no"  class="btn btn-ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="sys-confirm-yes" class="btn">ã¯ã„</button>
            </div>
          </div>
        </div>
        <!-- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç«‹ã¡ä¸Šã’å›é¿ç­–ï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§ -->


<script>

/** =========================
 *  Continue å…¨ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒç©ºãªã‚‰ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
 *  ========================= */

// ã©ã“ã‹1ã‹æ‰€ã§ä½¿ã£ã¦ã„ã‚‹ä¿å­˜ã‚­ãƒ¼ã®æ¥é ­è¾ã«åˆã‚ã›ã¦ãã ã•ã„
const SAVE_PREFIX = "offlove_slot_";

function hasAnySave() {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«1ã¤ã§ã‚‚ã‚»ãƒ¼ãƒ–ãŒã‚ã‚Œã° true
  return Object.keys(localStorage).some(k => k.startsWith(SAVE_PREFIX));
}

function updateContinueButton() {
  const btn = document.getElementById("btn-continue");
  if (!btn) return;
  const enabled = hasAnySave();
  btn.disabled = !enabled;
  btn.classList.toggle("disabled", !enabled); // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒ1ã¤ã‚‚ãªã‘ã‚Œã°è¦‹ãŸç›®ã®ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
}




/** =========================
 *  Constants / Utilities
 *  ========================= */

// Loadãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸç™ºç«å…ƒ: "ingame" | "title"
let loadInvokeFrom = "ingame"; //ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã¨ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã€Œã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã—åˆ†ã‘ã‚‹ãŸã‚

const SAVE_KEY = "offlove_save_v1";
const PROFILE_KEY = "offlove_profile_v1"; // ä¸»äººå…¬ã®åå‰ä¿å­˜
const el = (id) => document.getElementById(id);

// æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«â†“â†“â†“ã“ã“ã‹ã‚‰
function showConfirm(message, onYes, onNo) {
  const modal = el("sys-confirm");
  const msgEl = el("sys-confirm-message");
  const yesBtn = el("sys-confirm-yes");
  const noBtn  = el("sys-confirm-no");

  msgEl.textContent = message;
  modal.classList.remove("hidden");

  const cleanup = () => {
    modal.classList.add("hidden");
    yesBtn.removeEventListener("click", handleYes);
    noBtn.removeEventListener("click", handleNo);
  };

  function handleYes() {
    cleanup();
    if (onYes) onYes();
  }
  function handleNo() {
    cleanup();
    if (onNo) onNo();
  }

  yesBtn.addEventListener("click", handleYes);
  noBtn.addEventListener("click", handleNo);
}
// æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«â†‘â†‘â†‘ã“ã“ã¾ã§

const pages = {
  title: el("page-title"),
  settings: el("page-settings"),
  scene: el("page-scene"),
  result: el("page-result")
};
function showPage(key) {
  for (const k of Object.keys(pages)) {
    pages[k].classList.toggle("hidden", k !== key);
  }
  // â˜… scene ä»¥å¤–ã«å‡ºãŸã‚‰AUTOã¯OFF
  if (key !== "scene") {
    try { setAuto(false); } catch(_) {}
  }
  if (key === "title") {
    updateContinueButton(); // â† ã‚¹ãƒ­ãƒƒãƒˆã®æœ‰ç„¡ã§continueãƒœã‚¿ãƒ³ã®disabledã‚’æ›´æ–°
    setTitleBG(); // â† è¿½åŠ ï¼šã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã”ã¨ã«èƒŒæ™¯ã‚’ãƒ©ãƒ³ãƒ€ãƒ æ›´æ–°
  }
}

// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ä¸‰æšã®èƒŒæ™¯ç”»åƒã‚’åˆ‡æ›¿â†“â†“â†“ã“ã“ã‹ã‚‰
// ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯ï¼šå€™è£œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚»ãƒƒãƒˆï¼ˆç›´å‰ã¨åŒã˜ã¯é¿ã‘ã‚‹ï¼‰
function setTitleBG() {
  const bgEl = document.getElementById("title-bg");
  if (!bgEl) return;

  // ç”»åƒã¯å¥½ãã«å¢—ã‚„ã›ã¾ã™ã€‚æ‹¡å¼µå­ã¯å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã«åˆã‚ã›ã¦ã€‚
  const pool = [
    "assets/title/bg/studio.png",
    "assets/title/bg/hand.png",
    "assets/title/bg/music.png"
  ];

  // ç›´å‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é¿ã‘ã‚‹ï¼ˆsessionStorageã«è¨˜æ†¶ï¼‰
  const prev = Number(sessionStorage.getItem("title_bg_idx"));
  let idx = Math.floor(Math.random() * pool.length);
  if (pool.length > 1 && idx === prev) {
    idx = (idx + 1) % pool.length;
  }
  sessionStorage.setItem("title_bg_idx", String(idx));

  // ãƒ•ã‚§ãƒ¼ãƒ‰åˆ‡æ›¿
  bgEl.style.opacity = "0";
  const url = `url("${pool[idx]}")`;
  // ã¡ã‚‡ã£ã¨é…ã‚‰ã›ã¦ãƒ•ã‚§ãƒ¼ãƒ‰
  setTimeout(() => {
    bgEl.style.backgroundImage = url;
    bgEl.style.opacity = "1";
  }, 80);
}
// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ä¸‰æšã®èƒŒæ™¯ç”»åƒã‚’åˆ‡æ›¿â†‘â†‘â†‘ã“ã“ã¾ã§

// ==== Title Footer Deco ==== â†“â†“â†“ã“ã“ã‹ã‚‰
(function(){
  const deco = document.getElementById("title-footer-deco");
  if (!deco) return;

  const chars = ["â˜…","â˜†","â™ª","â™«","â™¡","â™©","ğŸ¸","ğŸ¶","ğŸ§","ğŸ’›","â¤","ğŸ’™","ğŸ’š","ğŸ’œ","ğŸ’•"]; // å¤©ä½“ãƒ»éŸ³æ¥½ãƒ»ä¹™å¥³
  const colors = ["#F09199","#FFD6E0","#FFF","#C8E4FF","#FCE3B7"];

  function spawn(){
    const el = document.createElement("span");
    el.textContent = chars[Math.floor(Math.random()*chars.length)];
    el.style.left = Math.random()*90 + "%";
    el.style.color = colors[Math.floor(Math.random()*colors.length)];
    el.style.fontSize = (14 + Math.random()*12) + "px";
    el.style.animationDuration = (4 + Math.random()*3) + "s";
    deco.appendChild(el);
    setTimeout(()=> el.remove(), 8000);
  }

  setInterval(spawn, 400); // 0.9ç§’ã”ã¨ã«ä¸€ã¤ç”Ÿæˆ
})();
// ==== Title Footer Deco ==== â†‘â†‘â†‘ã“ã“ã¾ã§

/** =========================
 *  Player Profile (ä¸»äººå…¬å)
 *  ========================= */
const defaultProfile = { family: "æ©˜", given: "èŒé¦™" };
const profile = loadProfile();
function loadProfile() {
  try {
    const raw = localStorage.getItem(PROFILE_KEY);
    if (!raw) return { ...defaultProfile };
    const p = JSON.parse(raw);
    return {
      family: (p && p.family) ? String(p.family) : defaultProfile.family,
      given:  (p && p.given)  ? String(p.given)  : defaultProfile.given
    };
  } catch {
    return { ...defaultProfile };
  }
}
function saveProfile() {
  localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
}

/** =========================
 *  View Settingsï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºï¼‰
 *  ========================= */
const SETTINGS_KEY = "offlove_settings_v1";
const defaultSettings = {
  fontSize: "m", // s/m/l/xl
  theme: "auto",         // auto/dark/light
  textSpeed: "normal"    // instant/normal/slow
 };

 let settings = loadSettings();

function loadSettings() {
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (!raw) return { ...defaultSettings };
    const st = JSON.parse(raw);
    return {
      fontSize: st?.fontSize ?? defaultSettings.fontSize,
      theme:    st?.theme    ?? defaultSettings.theme,
      textSpeed:st?.textSpeed?? defaultSettings.textSpeed 
     };
  } catch {
    return { ...defaultSettings };
  }
}
function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

// ãƒ†ãƒ¼ãƒé©ç”¨ï¼š<html> ã« theme-â—¯â—¯ ã‚’ä»˜ä¸ï¼ˆauto ã®ã¨ãã¯ OS ã‚’è¦‹ã‚‹ï¼‰
function applyTheme() {
  const root = document.documentElement;
  root.classList.remove("theme-dark","theme-light");
  let mode = settings.theme;
  if (mode === "auto") {
    const prefersDark = window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    mode = prefersDark ? "dark" : "light";
  }
  root.classList.add(`theme-${mode}`);
}

// ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºé©ç”¨ï¼ˆæ—¢å­˜ï¼‰
function applyFontSize() {
  // ãƒ«ãƒ¼ãƒˆè¦ç´ ã«ã‚µã‚¤ã‚ºåˆ¥ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
  const root = document.documentElement; // <html>
  root.classList.remove("fs-s","fs-m","fs-l","fs-xl");
  root.classList.add(`fs-${settings.fontSize}`);
}
// èµ·å‹•æ™‚ã«é©ç”¨
applyFontSize();
applyTheme();

// OSãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–ï¼ˆautoæ™‚ã®ã¿åæ˜ ï¼‰
if (window.matchMedia) {
  const mq = window.matchMedia("(prefers-color-scheme: dark)");
  mq.addEventListener?.("change", () => {
    if (settings.theme === "auto") applyTheme();
  });
}

/** =========================
 *  Game State & Save
 *  ========================= */
const state = {
  sceneId: "prologue_studio",
  cursor: 0,
  vars: {},
  log: [],
  history: [],             // è¿½åŠ ï¼šãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ [{type:'say'|'narrate', ch?, txt}]
  seenStills: [],          // è¿½åŠ ï¼šè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ« ["haruto:kiss01", ...]
  affection: { haruto: 0, tsukasa: 0 },
  script: null,
  undoStack: [],                // è¿½åŠ ï¼šå·»ãæˆ»ã—ç”¨
  backLockAt: null,              // è¿½åŠ : å¢ƒç•Œï¼ˆé¸æŠç›´å¾Œã®1è¡Œï¼‰ã‚’è¦šãˆã‚‹
  affFine: { haruto: 0, tsukasa: 0 }   // æ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼ˆ0ã€œ100ï¼‰
};

function resetState() {
  state.sceneId = "prologue_studio";
  state.cursor = 0;
  state.vars = {};
  state.log = [];
  state.history = [];      // è¿½åŠ ï¼šãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´
  state.seenStills = [];   // è¿½åŠ ï¼šè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ«
  state.affection = { haruto: 0, tsukasa: 0 };
  state.undoStack = [];        // è¿½åŠ ï¼šå·»ãæˆ»ã—ç”¨
  state.backLockAt = null;   // è¿½åŠ ï¼šé¸æŠç›´å¾Œã®1è¡Œã ã‘æˆ»ã‚‹ä¸å¯
  state.affFine = { haruto: 0, tsukasa: 0 }; // æ¬¡ã®â™¥ã¾ã§ï¼… ã‚’å…ˆã«åˆæœŸåŒ–
  updateAffDebug();         // â† ãã®å¾Œã«æç”»ï¼ˆæ›´æ–°ï¼‰

}
function save() {
  try {
    const payload = {
      sceneId: state.sceneId,
      cursor: state.cursor,
      vars: state.vars,
      log: state.log,
      history: state.history,         // è¿½åŠ ï¼šãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´
      seenStills: state.seenStills,   // è¿½åŠ ï¼šè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ«
      affection: state.affection,
      undoStack: state.undoStack,        // è¿½åŠ ï¼šå·»ãæˆ»ã—ç”¨
      backLockAt: state.backLockAt,   // è¿½åŠ ï¼šé¸æŠç›´å¾Œã®1è¡Œã ã‘æˆ»ã‚‹ä¸å¯
      affFine: state.affFine          // æ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼ˆ0ã€œ100ï¼‰ã‚’ç®¡ç†
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  } catch (e) {
    console.warn("save failed", e);
  }
}
function loadSave() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return null;
    const s = JSON.parse(raw);
    if (!s || typeof s !== 'object' || typeof s.sceneId !== 'string') return null;
    state.sceneId = s.sceneId;
    state.cursor = Number.isFinite(s.cursor) ? s.cursor : 0;
    state.vars = s.vars || {};
    state.log = Array.isArray(s.log) ? s.log : [];
    state.history = Array.isArray(s.history) ? s.history : [];         // è¿½åŠ ï¼šãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´
    state.affFine    = s.affFine    || { haruto: 0, tsukasa: 0 };    // æ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼ˆ0ã€œ100ï¼‰ã‚’ç®¡ç†

    // --- å±¥æ­´ã®ä¸»äººå…¬è¡¨è¨˜ã‚’ç¾åœ¨ã®â€œåå‰ã®ã¿â€ã¸ç§»è¡Œï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€åº¦ã ã‘ï¼‰ ---
    const mcName = profile.given;
    state.history = (state.history || []).map(h => {
      if (!h || h.type !== "say") return h;
      const isMCLine =
        h.mc === true || h.ch === "ä¸»äººå…¬" || h.ch === `${profile.family} ${profile.given}`;
      return isMCLine ? { ...h, ch: mcName, mc: true } : h;
    });

    state.seenStills = Array.isArray(s.seenStills) ? s.seenStills : []; // è¿½åŠ ï¼šè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ«
    state.affection = s.affection || { haruto: 0, tsukasa: 0 };
    state.undoStack = Array.isArray(s.undoStack) ? s.undoStack : []; // è¿½åŠ ï¼šå·»ãæˆ»ã—ç”¨
    state.backLockAt = (typeof s.backLockAt === "number") ? s.backLockAt : null; // è¿½åŠ ï¼šé¸æŠç›´å¾Œã®1è¡Œã ã‘æˆ»ã‚‹ä¸å¯
    return s;
  } catch (e) {
    console.warn("load failed", e);
    localStorage.removeItem(SAVE_KEY);
    return null;
  }
}

// ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ãŒç„¡ãã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼ã®å®‰å…¨åŒ–
const _btnNextEl = el("btn-next");
if (_btnNextEl) _btnNextEl.addEventListener("click", next);

// å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­ã¯ã‚¿ãƒƒãƒ—ç„¡åŠ¹ã‚¬ãƒ¼ãƒ‰æœ‰ã‚Šï¼‰
el("btn-menu").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.remove("hidden");
  document.body.classList.add('modal-open');
});
el("btn-menu-close").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
});

// å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼
el("mnu-log").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
  renderLog(); el("log-modal").classList.remove("hidden");
});

// Optionï¼ˆã‚¿ã‚¤ãƒ—é€Ÿåº¦ã®ã¿ä¿å­˜ãƒ»åæ˜ ï¼‰
el("mnu-opt").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
  // æ—¢å­˜è¨­å®šã‚’åæ˜ ï¼ˆã ã„ãŸã„ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
  el("opt-type").value = settings.textSpeed;
  el("option-modal").classList.remove("hidden");
});
el("btn-option-save").addEventListener("click", ()=>{
  settings.textSpeed = el("opt-type").value;
  saveSettings();
  el("option-modal").classList.add("hidden");
});

// Help
el("mnu-help").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
  el("help-modal").classList.remove("hidden");
});

// Titleï¼ˆæ—¢å­˜ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†åˆ©ç”¨ï¼‰
el("mnu-title").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
  el("home-confirm").classList.remove("hidden");
});
// ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒãƒ³ãƒ‰ãƒ©
el("btn-home-no").addEventListener("click", () => {
  el("home-confirm").classList.add("hidden");
});
el("btn-home-yes").addEventListener("click", () => {
  save(); // è‡ªå‹•ä¿å­˜
  el("home-confirm").classList.add("hidden");
  showPage("title"); // ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
});


/* Status â†“â†“â†“ã“ã“ã‹ã‚‰*/
// Statusï¼ˆå‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰

let statusPage = 0;        // 0:åŸºæœ¬æƒ…å ±, 1:å¥½æ„Ÿåº¦(HT)
const STATUS_PAGE_TOTAL = 2;

const HEARTS = [
  { key:"haruto",  label:"ç¥è°· é™½ç¿”" },
  { key:"koh",     label:"æ°´ç„¡æœˆ ç…Œ" },
  { key:"ryoya",   label:"å¤©ç¾½ æ¶¼å¼¥" },
  { key:"rei",     label:"æ°·å ‚ æ€œ" },
  { key:"tsukasa", label:"ä¹æ¡ å¸" }
];
/* å¥½æ„Ÿåº¦ãƒšãƒ¼ã‚¸è¨­å®šâ†“â†“â†“ã“ã“ã‹ã‚‰*/
// Statusã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’HUDç”¨ã«ã‚‚è¿”ã™å…±é€šUIï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨å¥½æ„Ÿåº¦è¡¨ç¤ºï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰

function heartMeterFor(key){         // key: "haruto" | "tsukasa" | ã»ã‹
  // å®Ÿå€¤ï¼ˆæ•´æ•°â™¥ã¨éƒ¨åˆ†ï¼…ï¼‰â†’ è¡¨ç¤ºç”¨ 0ã€œ100 ã«åˆæˆ
  const int  = (state.affection?.[key] ?? 0);    // 0..4ï¼ˆãƒ™ãƒ¼ã‚¹â™¥ã¯UIå´ã§ï¼‹1ï¼‰
  const fine = (state.affFine?.[key] ?? 0);      // 0..100ï¼ˆæ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼‰
  const pct  = Math.max(0, Math.min(100, int * 20 + Math.round(fine * 0.2)));

  const isMax = (pct === 100);
  const filledCount = Math.min(5, 1 + Math.floor(pct / 20)); // æœ€ä½â™¥1

  const hearts = Array.from({length:5}, (_,i)=>
    `<span class="${i < filledCount ? 'filled' : 'empty'}">â™¥</span>`
  ).join("");

  return `
    <div class="ht-wrap ${isMax ? 'max' : ''}">
      <div class="ht-hearts ${key}">${hearts}</div>
    </div>
  `;  //â™¥ã®ã¿è¡¨ç¤º
}
// Statusã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’HUDç”¨ã«ã‚‚è¿”ã™å…±é€šUIï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨å¥½æ„Ÿåº¦è¡¨ç¤ºï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§
// progress: 0-100 / variant: "haruto" | "tsukasa" | undefined
function heartsUI(progress, variant){
  const pct = Math.max(0, Math.min(100, progress || 0));

  // â˜…æœ€ä½1å€‹ã¯ç‚¹ç¯ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã©ãŠã‚Šï¼‰
  const baseHearts   = 1;
  const heartsFromPct= Math.floor(pct / 20);        // 0..5
  const filledCount  = Math.min(5, baseHearts + heartsFromPct);

  const hearts = Array.from({length:5}, (_,i)=>
    `<span class="${i<filledCount?'filled':'empty'}">â™¥</span>`
  ).join("");

  const isMax   = (pct === 100);
  const stepPct = (pct === 100) ? 100 : Math.round((pct % 20) / 20 * 100); // ãƒãƒ¼ã¯æ®µéšå†…%ã«ã™ã‚‹ãªã‚‰ã“ã‚Œï¼ˆ0ã€œ100ï¼‰
  // æ®µéšå¤–ã®ç·åˆ%è¡¨ç¤ºã®ã¾ã¾ãŒè‰¯ã‘ã‚Œã°ä¸Šã‚’ pct ã«æˆ»ã—ã¦ãã ã•ã„

  return `
    <div class="ht-wrap ${isMax ? 'max' : ''}">
      <div class="ht-hearts ${variant ? variant : ''}">${hearts}</div>
      <div class="ht-bar">
        <div class="fill" data-w="${stepPct}"></div>
        <div class="label">${isMax ? "" : `${stepPct}%`}</div>
      </div>
    </div>`;
}
/* å¥½æ„Ÿåº¦ãƒšãƒ¼ã‚¸è¨­å®šâ†‘â†‘â†‘ã“ã“ã¾ã§*/

function renderStatus(){
  const dateStr = state.vars.gameTime || "1å¹´ç›®ã€€æ˜¥ã€€3é€±ç›®ã€€æ°´æ›œæ—¥ã€€æœã€€å¿«æ™´"; // ä»®
  const mcFull  = `${profile.family} ${profile.given}`;

  // 5äººåˆ†ã®å¥½æ„Ÿã¯ Haruto/Tsukasaä»¥å¤–ã¯0%ã®ã‚¬ãƒ¯â†“â†“â†“ã“ã“ã‹ã‚‰
  // 5äººåˆ†ã®å¥½æ„Ÿã¯ Haruto/Tsukasa ã¯å®Ÿå€¤Ã—20ã€ä»–ã¯ãƒ‡ãƒ¢ç”¨ã®è¦‹ãŸç›®å€¤
  const affPct = (key)=> {
    // haruto/tsukasa ã¯ â™¥æ•´æ•°ï¼‹ï¼… ã‚’åˆæˆã—ãŸè¡¨ç¤ºç”¨ 0..100 ã‚’è¿”ã™
    if (key === "haruto" || key === "tsukasa") return affPctKey(key);
    // ä»–ãƒ¡ãƒ³ãƒãƒ¼ã¯ãƒ‡ãƒ¢å€¤ã®ã¾ã¾
    const clamp = n => Math.max(0, Math.min(100, n|0));
    const demo = { koh: 35, ryoya: 100, rei: 60 };
    return clamp(demo[key] ?? 0);
  };
  
  // 5äººåˆ†ã®å¥½æ„Ÿã¯ Haruto/Tsukasaä»¥å¤–ã¯0%ã®ã‚¬ãƒ¯â†‘â†‘â†‘ã“ã“ã¾ã§

  const htList = HEARTS.map(h=>{
    const name = renderNameLabel(h.label); // ä¾‹: ç¥è°· é™½ç¿” <span class="kana">- ã‚«ãƒŸãƒ¤ ãƒãƒ«ãƒˆ -</span>
    return `
      <div class="card" style="padding:10px; margin-top:8px;">
        <div style="font-weight:700;">ğŸ’–${name}</div>
        <div>${heartsUI(
                affPct(h.key),
                  h.key // â† å…¨å“¡ã® key ã‚’ãã®ã¾ã¾ variant ã¨ã—ã¦æ¸¡ã™
              )}
        </div>
      </div>
    `;
  }).join("");

  const box = el("status-body");
  box.innerHTML = "";

  // ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆä¸Šï¼‰
  box.appendChild(buildPager(
    statusPage, STATUS_PAGE_TOTAL,
    ()=>{ if(statusPage>0){ statusPage--; renderStatus(); } },
    ()=>{ if(statusPage<STATUS_PAGE_TOTAL-1){ statusPage++; renderStatus(); } }
  ));

  // ãƒšãƒ¼ã‚¸ã”ã¨ã®ä¸­èº«
  if (statusPage === 0) {
    // ---- 1ãƒšãƒ¼ã‚¸ç›®ï¼šåŸºæœ¬æƒ…å ± ----
    box.insertAdjacentHTML("beforeend", `
      <div class="card"><strong>â– æ—¥æ™‚</strong><div class="subtitle">${dateStr}</div></div>
      <div class="card" style="margin-top:8px;">
        <strong>â– ä¸»äººå…¬ã®åå‰</strong><div class="subtitle">${mcFull}</div>
      </div>
      <div class="card" style="margin-top:8px;">
        <strong>â– ä¸»äººå…¬ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong>
        <div class="meta">ï¼ˆãƒ—ãƒ­ãƒˆç‰ˆã§ã¯ã‚¬ãƒ¯ã®ã¿ï¼‰</div>
        <div class="list" style="margin-top:6px;">
          <div class="list-item"><strong>LVã€€3</strong><div class="meta">ã€Levelã€‘XPãŒåŸºæº–å€¤ã«é”ã™ã‚‹ã¨ä¸Šæ˜‡ã™ã‚‹è·å‹™ã‚¹ã‚­ãƒ«</div></div>
          <div class="list-item"><strong>XPã€€200</strong><div class="meta">ã€Experience Pointsã€‘ä»•äº‹ã«é–¢ã‚ã‚‹çµŒé¨“ã‚’ç©ã‚€ã¨ç²å¾—</div></div>
          <div class="list-item"><strong>STã€€10</strong><div class="meta">ã€Staminaã€‘ä¼‘æ—¥ã®æ´»å‹•å†…å®¹ã«å¿œã˜ã¦æ¶ˆè²»</div></div>
          <div class="list-item"><strong>FTã€€0</strong><div class="meta">ã€Fatigueã€‘XPã®ç²å¾—é€Ÿåº¦ã«å¿œã˜ã¦è“„ç©</div></div>
        </div>
      </div>
    `);
  } else {
    // ---- 2ãƒšãƒ¼ã‚¸ç›®ï¼šå¥½æ„Ÿåº¦ï¼ˆHTï¼‰ ----
    box.insertAdjacentHTML("beforeend", `
      <div class="card"><strong>â– ã€Heartã€‘å¥½æ„Ÿåº¦ï¼ˆHTï¼‰</strong><div class="meta">ï¼ˆã‚¿ãƒƒãƒ—ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã€ãƒ—ãƒ­ãƒˆç‰ˆã§ã¯æœªå®Ÿè£…ï¼‰</div>${htList}</div>
    `);
  }

  // é€²æ—ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ï¼ˆwidth 0 â†’ data-w%ï¼‰
  box.querySelectorAll(".ht-bar .fill").forEach(el=>{
    const w = el.getAttribute("data-w") || "0";
    // 2ãƒ•ãƒ¬ãƒ¼ãƒ é…å»¶ã§ç¢ºå®Ÿã«ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³
    el.style.width = "0%";
    requestAnimationFrame(()=> requestAnimationFrame(()=> el.style.width = w + "%"));
  });

  // ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆä¸‹ï¼‰
  box.appendChild(buildPager(
    statusPage, STATUS_PAGE_TOTAL,
    ()=>{ if(statusPage>0){ statusPage--; renderStatus(); } },
    ()=>{ if(statusPage<STATUS_PAGE_TOTAL-1){ statusPage++; renderStatus(); } }
  ));
}

el("mnu-status").addEventListener("click", ()=>{
  el("mainmenu-modal").classList.add("hidden");
  statusPage = 0;           // â˜… è¿½è¨˜ï¼šæ¯å›1ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰
  renderStatus();
  el("status-modal").classList.remove("hidden");
});
/* Status â†‘â†‘â†‘ã“ã“ã¾ã§*/

//Save / Loadï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ç°¡æ˜“ã‚¹ãƒ­ãƒƒãƒˆå®Ÿè£…ï¼‰
//ä»•æ§˜ï¼š 50ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ1â€“50ï¼‰ã€UIã¯ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã¿ã€‚å®Ÿè£…ã‚’è»½ãã™ã‚‹ãŸã‚ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–10æ ã®ä»•çµ„ã¿ã¯å¾Œæ—¥ã€‚
const SLOT_PREFIX = "offlove_slot_"; // ä¾‹: offlove_slot_3
const MANUAL_TOTAL = 40;
const AUTO_TOTAL   = 10;
const SLOTS_PER_PAGE = 10;

let saveMode = "manual"; // "manual" | "auto"
let loadMode = "manual"; // "manual" | "auto"
let savePage = 0; // 0-based
let loadPage = 0; // 0-based

function saveToSlot(slot){
  const payload = {
    savedAt: Date.now(),
    state: {
      sceneId: state.sceneId, cursor: state.cursor,
      vars: state.vars, log: state.log, history: state.history,
      seenStills: state.seenStills, affection: state.affection,
      affFine: state.affFine
    },
    profile, settings
  };
  localStorage.setItem(SLOT_PREFIX+slot, JSON.stringify(payload));
}

//ä¿å­˜æœ‰ç„¡ã®åˆ¤å®šãƒ˜ãƒ«ãƒ‘â†“â†“â†“ã“ã“ã‹ã‚‰
function hasManualSlot(slot){
  return !!localStorage.getItem(SLOT_PREFIX + slot);
}
//ä¿å­˜æœ‰ç„¡ã®åˆ¤å®šãƒ˜ãƒ«ãƒ‘â†‘â†‘â†‘ã“ã“ã¾ã§

//JSON ãŒãŠã‹ã—ã„ç­‰ã®æœ¬å½“ã®ãƒã‚°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ãã®ã¾ã¾è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‡¦ç†â†“â†“â†“ã“ã“ã‹ã‚‰
function loadFromSlot(slot) {
  const raw = localStorage.getItem(SLOT_PREFIX + slot);
  if (!raw) {
    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ â†’ ãƒ­ãƒ¼ãƒ‰å¤±æ•—
    return false;
  }

  const s = JSON.parse(raw);

  // å¿…è¦æœ€ä½é™ã‚’å¾©å…ƒï¼ˆã“ã“ã§ã¯ç”»é¢æç”»ï¼ˆshowPage("scene"); setBG(); renderCurrent();ï¼‰ã¯ã—ãªã„ï¼‰
  Object.assign(state,    s.state    || {});
  Object.assign(profile,  s.profile  || profile);
  Object.assign(settings, s.settings || settings);

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»è¨­å®šã¯æ°¸ç¶šåŒ–
  saveProfile();
  saveSettings();

  // ã“ã“ã¾ã§æ¥ã‚Œã°ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
  return true;
}
//JSON ãŒãŠã‹ã—ã„ç­‰ã®æœ¬å½“ã®ãƒã‚°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ãã®ã¾ã¾è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‡¦ç†â†‘â†‘â†‘ã“ã“ã¾ã§

function slotLabel(slot){
  const raw = localStorage.getItem(SLOT_PREFIX+slot);
  if(!raw) return `ã‚¹ãƒ­ãƒƒãƒˆNo.${slot}ï¼ˆç©ºï¼‰`;
  try{
    const s = JSON.parse(raw); const d = new Date(s.savedAt||Date.now());
    const ts = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
    return `ã‚¹ãƒ­ãƒƒãƒˆNo.${slot}ï¼ˆ${ts}ï¼‰`;
  }catch{ return `ã‚¹ãƒ­ãƒƒãƒˆNo.${slot}`; }
}

//ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒšãƒ¼ã‚¸åˆ‡æ›¿æ©Ÿèƒ½ä»˜ãï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰


// â–¼ ãƒ©ãƒ™ãƒ«ç”Ÿæˆï¼ˆè¦‹ãŸç›®ã ã‘ã§OKï¼‰
function slotLabelBy(mode, index1){ // index1: 1å§‹ã¾ã‚Š
  if (mode === "manual") {
    const raw = localStorage.getItem(SLOT_PREFIX + index1);
    if (!raw) return `No.${String(index1).padStart(2,"0")}ï¼ˆç©ºï¼‰`;
    try{
      const s = JSON.parse(raw); 
      const d = new Date(s.savedAt || Date.now());
      const ts = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      return `No.${String(index1).padStart(2,"0")}ï¼ˆ${ts}ï¼‰`;
    }catch{
      return `No.${String(index1).padStart(2,"0")}`;
    }
  } else {
    // ã‚ªãƒ¼ãƒˆã¯ãƒ€ãƒŸãƒ¼è¡¨ç¤ºï¼ˆã‚¬ãƒ¯ã ã‘ï¼‰
    return `ã€AUTOã€‘No.${String(index1).padStart(2,"0")}ï¼ˆè‡ªå‹•ï¼‰`;
  }
}

// â–¼ ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆå…±é€šé–¢æ•°ã€‚ä¸¡æ–¹ã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç½®ãï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰

function buildPager(current, totalPages, onPrev, onNext){
  const nav = document.createElement("div");
  nav.className = "row";
  nav.style.margin = "12px 0";
  nav.innerHTML = `
    <button class="btn" ${current<=0?"disabled":""}>â¬…ï¸</button>
    <div style="flex:1;text-align:center;">Page ${current+1} / ${totalPages}</div>
    <button class="btn" ${current>=totalPages-1?"disabled":""}>â¡ï¸</button>
  `;
  const buttons = nav.querySelectorAll("button");
  const btnPrev = buttons[0];
  const btnNext = buttons[1];
  btnPrev.addEventListener("click", onPrev);
  btnNext.addEventListener("click", onNext);
  return nav;
}

// â–¼ ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆå…±é€šé–¢æ•°ã€‚ä¸¡æ–¹ã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç½®ãï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§

// â–¼ Saveï¼ˆãƒšãƒ¼ã‚¸ãƒ£ä»˜ãï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰
function renderSaveList(){
  const box = el("save-list");
  box.innerHTML = "";

  const total = (saveMode==="manual") ? MANUAL_TOTAL : AUTO_TOTAL;
  const start = savePage * SLOTS_PER_PAGE;
  const end   = Math.min(start + SLOTS_PER_PAGE, total);
  const pageCount = Math.max(1, Math.ceil(total / SLOTS_PER_PAGE));

  // ä¸Šéƒ¨ãƒšãƒ¼ã‚¸ãƒ£
  box.appendChild(buildPager(
    savePage, pageCount,
    ()=>{ if(savePage>0){ savePage--; renderSaveList(); } },
    ()=>{ if(savePage<pageCount-1){ savePage++; renderSaveList(); } }
  ));

  // ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆãƒªã‚¹ãƒˆ

  for (let i = start + 1; i <= end; i++) {
  const has = hasManualSlot(i);
  const div = document.createElement("div");
  div.className = "list-item";
  div.innerHTML = `
    <div class="row" style="align-items:center; gap:8px;">
      <div style="flex:1;">
        <strong>${slotLabelBy(saveMode, i)}</strong>
        <div class="meta">${saveMode==="manual" ? "ã‚¯ãƒªãƒƒã‚¯ã§ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã«ä¿å­˜ã—ã¾ã™" : "ï¼ˆAUTOæ ï¼šä¿å­˜æ“ä½œä¸å¯ï¼è¦‹ãŸç›®ã®ã¿ï¼‰"}</div>
      </div>
      ${saveMode==="manual" && has ? `<button class="btn-del" data-del="${i}">å‰Šé™¤</button>` : ""}
    </div>
  `;

  if (saveMode === "manual") {
    // ã‚»ãƒ¼ãƒ–å®Ÿè¡Œï¼ˆæœ¬ä½“ã¯ã‚¬ãƒ¯ã®ã¾ã¾ãªã‚‰æ™‚é–“ã ã‘æ›´æ–°ï¼‰
    div.addEventListener("click", (e) => {
      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯æ‹¾ã‚ãªã„
      if (e.target.closest("button[data-del]")) return;
        showConfirm(
          `ã‚¹ãƒ­ãƒƒãƒˆ No.${i} ã«ã‚»ãƒ¼ãƒ–ã—ã¾ã™ã‹ï¼Ÿ`,
          () => {
          const payload = { savedAt: Date.now(), state:{
      sceneId: state.sceneId, cursor: state.cursor,
      vars: state.vars, log: state.log, history: state.history,
      seenStills: state.seenStills, affection: state.affection,
      affFine: state.affFine
    }, profile, settings };
          localStorage.setItem(SLOT_PREFIX+i, JSON.stringify(payload));
          renderSaveList();
          updateContinueButton(); // â† Save ãƒªã‚¹ãƒˆã®ä¿å­˜ç›´å¾Œã«Continueãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ›´æ–°
        }
      );
  });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const delBtn = div.querySelector('button[data-del]');
    if (delBtn) {
      delBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
          showConfirm(
            `ã‚¹ãƒ­ãƒƒãƒˆ No.${i} ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
              () => {
              localStorage.removeItem(SLOT_PREFIX+i);
            renderSaveList();
            updateContinueButton(); // â† Save ãƒªã‚¹ãƒˆã®å‰Šé™¤ç›´å¾Œã«Continueãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ›´æ–°
          }
        )
      });
    }
  }
  box.appendChild(div);
}


  // ä¸‹éƒ¨ãƒšãƒ¼ã‚¸ãƒ£
  box.appendChild(buildPager(
    savePage, pageCount,
    ()=>{ if(savePage>0){ savePage--; renderSaveList(); } },
    ()=>{ if(savePage<pageCount-1){ savePage++; renderSaveList(); } }
  ));
}
// â–¼ Saveï¼ˆãƒšãƒ¼ã‚¸ãƒ£ä»˜ãï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§

// â–¼ Loadï¼ˆãƒšãƒ¼ã‚¸ãƒ£ä»˜ãï¼‰â†“â†“â†“ã“ã“ã‹ã‚‰
// â–¼ Loadï¼ˆ5ãƒšãƒ¼ã‚¸ç›®ã¯AUTOã®ã‚¬ãƒ¯ã‚’è¡¨ç¤ºï¼‰
function renderLoadList(){
  const box = el("load-list");
  box.innerHTML = "";

  // Loadã¯å¸¸ã«5ãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼ˆ1ã€œ4=æ‰‹å‹•40æ ã€5=ã‚ªãƒ¼ãƒˆ10æ ã®ãƒ€ãƒŸãƒ¼ï¼‰
  const pageCount = 5;
  const isAutoPage = (loadPage === 4);           // 0å§‹ã¾ã‚Š â†’ 4 ãŒ5ãƒšãƒ¼ã‚¸ç›®
  const total = isAutoPage ? AUTO_TOTAL : MANUAL_TOTAL;

  // æ‰‹å‹•ãƒšãƒ¼ã‚¸ã¯ 0..3 ã‚’ 10ä»¶ãšã¤ã€AUTOãƒšãƒ¼ã‚¸ã¯å¸¸ã« 1..10
  const start = isAutoPage ? 0 : loadPage * SLOTS_PER_PAGE;
  const end   = Math.min(start + SLOTS_PER_PAGE, total);

  // ãƒ©ãƒ™ãƒ«ç”¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚‚ã“ã“ã§åˆ‡æ›¿ï¼ˆAUTOãƒšãƒ¼ã‚¸ã®ã¿ã€AUTOã€‘è¡¨ç¤ºï¼‰
  const mode = isAutoPage ? "auto" : "manual";

  // ä¸Šéƒ¨ãƒšãƒ¼ã‚¸ãƒ£
  box.appendChild(buildPager(
    loadPage, pageCount,
    ()=>{ if(loadPage>0){ loadPage--; renderLoadList(); } },
    ()=>{ if(loadPage<pageCount-1){ loadPage++; renderLoadList(); } }
  ));

  // ã‚¹ãƒ­ãƒƒãƒˆ

  for (let i = start + 1; i <= end; i++) {
  const isAuto = isAutoPage;
  const slotNo = i; // æ‰‹å‹•æ™‚ã®å®Ÿã‚¹ãƒ­ãƒƒãƒˆç•ªå·
  const has = !isAuto && hasManualSlot(slotNo);

  // ãƒ©ãƒ™ãƒ«ç•ªå·ï¼šæ‰‹å‹•ã¯é€šã—ï¼ˆ01ã€œ40ï¼‰ã€AUTOãƒšãƒ¼ã‚¸ 41ã€œ50
  const labelNo = isAutoPage ? (40 + i - start) : i;

  // ãƒ¡ã‚¿è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
  const metaText = isAuto
    ? "ï¼ˆAUTOæ ï¼šãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ãƒ­ãƒ¼ãƒ‰æ“ä½œä¸å¯ï¼è¦‹ãŸç›®ã®ã¿ï¼‰"
    : (has ? "ã‚¯ãƒªãƒƒã‚¯ã§ãƒ­ãƒ¼ãƒ‰" : "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—");

  const div = document.createElement("div");
  div.className = "list-item";
  if (!has && !isAuto) {
    // æ‰‹å‹•ãƒšãƒ¼ã‚¸ã®ç©ºã‚¹ãƒ­ãƒƒãƒˆã¯ã€Œç„¡åŠ¹ã€æ‰±ã„ã«ã™ã‚‹
    div.classList.add("slot-empty");
  }

  div.innerHTML = `
    <div class="row" style="align-items:center; gap:8px;">
      <div style="flex:1;">
        <strong>${slotLabelBy(mode, labelNo)}</strong>
        <div class="meta">${metaText}</div>
      </div>
      ${(!isAuto && has) ? `<button class="btn-del" data-del="${slotNo}">å‰Šé™¤</button>` : ""}
    </div>
  `;

// ã‚¯ãƒªãƒƒã‚¯ã§ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‰‹å‹•ãƒšãƒ¼ã‚¸ã®ã¿ï¼‰
  if (!isAutoPage && has) {
    div.addEventListener("click", (e)=>{
      if (e.target.closest("button[data-del]")) return; // å‰Šé™¤ãƒœã‚¿ãƒ³ã¯é™¤å¤–

       const msg = (loadInvokeFrom === "title")
      ? `ã‚¹ãƒ­ãƒƒãƒˆ No.${slotNo} ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ`
      : `ã‚¹ãƒ­ãƒƒãƒˆ No.${slotNo} ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚`;

        showConfirm(
          msg, () => {
            const ok = loadFromSlot(slotNo);
            el("load-modal").classList.add("hidden");
            loadInvokeFrom = "ingame"; // â˜… ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡å›ã®ãŸã‚ï¼‰
            if (ok) {
              showPage("scene");
              setBG();
              renderCurrent();
            } else {
              // ã“ã“ã‚‚ãƒã‚¤ãƒ†ã‚£ãƒ– alert ã‚’é¿ã‘ãŸã„ãªã‚‰åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«åŒ–ã™ã‚‹
              alert("ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
              }  
            },
          () => {   // Noï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ã®ã¨ã
            // ä½•ã‚‚ã—ãªã„ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã«å‡¦ç†ã‚’æ›¸ãï¼‰
          }
      );

    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const delBtn = div.querySelector('button[data-del]');
    if (delBtn) {
      delBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
          showConfirm(
            `ã‚¹ãƒ­ãƒƒãƒˆ No.${slotNo} ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
            () => {
            localStorage.removeItem(SLOT_PREFIX+slotNo);
            renderLoadList();
            updateContinueButton(); // â† Load ãƒªã‚¹ãƒˆã®ä¿å­˜ç›´å¾Œã«Continueãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ›´æ–°
          }
        );
      });
    }
  }

  box.appendChild(div);
}


  // ä¸‹éƒ¨ãƒšãƒ¼ã‚¸ãƒ£
  box.appendChild(buildPager(
    loadPage, pageCount,
    ()=>{ if(loadPage>0){ loadPage--; renderLoadList(); } },
    ()=>{ if(loadPage<pageCount-1){ loadPage++; renderLoadList(); } }
  ));
}

// â–¼ Loadï¼ˆãƒšãƒ¼ã‚¸ãƒ£ä»˜ãï¼‰â†‘â†‘â†‘ã“ã“ã‹ã‚‰

//ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒšãƒ¼ã‚¸åˆ‡æ›¿æ©Ÿèƒ½ä»˜ãï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§

//ã‚¿ãƒ–éä¾å­˜ã®ãƒªã‚¹ãƒŠã€€â†“â†“â†“ã“ã“ã‹ã‚‰
// ---- Save/Load ã‚’ç¢ºå®Ÿã«é–‹ãå…±é€šé–¢æ•° ----
function openSaveModal() {
  saveMode = "manual";
  savePage = 0;
  try { renderSaveList(); } catch(e) { console.warn(e); }
  const m = el("save-modal");
  if (m) m.classList.remove("hidden");
}

function openLoadModal(from = "ingame") {   // â† å¼•æ•°ã‚’è¿½åŠ 
  loadInvokeFrom = from;                    // â˜… ã“ã“ã§ã€Œã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºã—åˆ†ã‘ã®çŠ¶æ³ã‚’è¨˜éŒ²
  loadMode = "manual";
  loadPage = 0;
  try { renderLoadList(); } catch(e) { console.warn(e); }
  const m = el("load-modal");
  if (m) m.classList.remove("hidden"); // â˜… è¡¨ç¤ºã•ã›ã‚‹ï¼ˆ.hidden ã‚’å¤–ã™å‡¦ç†ï¼‰
}

// ---- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã“ã“ã‚’ç½®ãæ›ãˆï¼‰----
el("mnu-save").addEventListener("click", () => {
  el("mainmenu-modal").classList.add("hidden");
  // 1ãƒ•ãƒ¬ãƒ¼ãƒ é…ã‚‰ã›ã¦ç¢ºå®Ÿã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  requestAnimationFrame(openSaveModal);
});
el("mnu-load").addEventListener("click", () => {
  el("mainmenu-modal").classList.add("hidden");
  requestAnimationFrame(() => openLoadModal("ingame"));  // â† "ingame" ã‚’æ¸¡ã™
});

//ã‚¿ãƒ–éä¾å­˜ã®ãƒªã‚¹ãƒŠã€€â†‘â†‘â†‘ã“ã“ã¾ã§

//â†‘â†‘â†‘Save / Loadï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ç°¡æ˜“ã‚¹ãƒ­ãƒƒãƒˆå®Ÿè£…ï¼‰ã“ã“ã¾ã§

// æŒ‡å®šã‚·ãƒ¼ãƒ³ã‹ã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆå…±é€šå‡¦ç†ï¼‰â€»Proto Only
function startGameAt(sceneId) {
  resetState();
  state.sceneId = sceneId; // ã“ã“ã§é–‹å§‹ã‚·ãƒ¼ãƒ³ã‚’æŒ‡å®š
  save();
  if (!parseScript()) { alert("å…ˆã« script_json ã‚’ Load ã—ã¦ãã ã•ã„ã€‚"); return; }
  showPage("scene");
  setBG();
  renderCurrent();
}

// ç½®ãæ›ãˆï¼ˆNew Game ãƒœã‚¿ãƒ³ï¼‰
el("btn-new").addEventListener("click", () => {
  if (!parseScript()) { alert("å…ˆã« script_json ã‚’ Load ã—ã¦ãã ã•ã„ã€‚"); return; }
  startGameAt("prologue_studio"); // â† ã„ããªã‚Šé™½ç¿”ã‹ã‚‰é–‹å§‹
});

/** =========================
 *  Script JSON
 *  ========================= */
let script_json = ""; // user pastes here
function parseScript() {
  try {
    const data = JSON.parse(script_json);
    if (!data || !Array.isArray(data.scenes)) throw new Error("Invalid script format");
    state.script = data;
    return true;
  } catch (e) {
    state.script = null;
    return false;
  }
}
function findScene(id) {
  if (!state.script) return null;
  return state.script.scenes.find(s => s.id === id) || null;
}

/** =========================
 *  Rendering helpers
 *  ========================= */
// æ”»ç•¥ã‚­ãƒ£ãƒ©ã®ãµã‚ŠãŒãªãƒãƒƒãƒ—ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ å¯èƒ½ï¼‰
const FURIGANA = {
  "é™½ç¿”": "ãƒãƒ«ãƒˆ",
  "ç…Œ": "ã‚³ã‚¦",
  "æ¶¼å¼¥": "ãƒªãƒ§ã‚¦ãƒ¤",
  "æ€œ": "ãƒ¬ã‚¤",
  "å¸": "ãƒ„ã‚«ã‚µ",
  "ç¥è°· é™½ç¿”": "ã‚«ãƒŸãƒ¤ ãƒãƒ«ãƒˆ",
  "æ°´ç„¡æœˆ ç…Œ": "ãƒŸãƒŠãƒ…ã‚­ ã‚³ã‚¦",
  "å¤©ç¾½ æ¶¼å¼¥": "ã‚¢ãƒãƒãƒ ãƒªãƒ§ã‚¦ãƒ¤",
  "æ°·å ‚ æ€œ": "ãƒ’ãƒ§ã‚¦ãƒ‰ã‚¦ ãƒ¬ã‚¤",
  "ä¹æ¡ å¸": "ã‚¯ã‚¸ãƒ§ã‚¦ ãƒ„ã‚«ã‚µ"
};
function renderNameLabel(ch) {
  // ä¸»äººå…¬ã¯ãµã‚ŠãŒãªä¸è¦ã€ã‹ã¤è¡¨ç¤ºåã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã«ç½®æ›
  if (ch === "ä¸»äººå…¬") {
    return `${profile.family} ${profile.given}`;
  }
  // æ”»ç•¥ã‚­ãƒ£ãƒ©ã¯ã€Œæ¼¢å­— -ã‚«ãƒŠ-ã€è¡¨è¨˜ï¼ˆcssã§ã‚¹ã‚¿ã‚¤ãƒ«ä»˜ä¸ï¼‰
  if (FURIGANA[ch]) {
    const kana = FURIGANA[ch];
    return `${ch} <span class="kana">- ${kana} -</span>`;
  }
  // ãã‚Œä»¥å¤–ã¯ç´ ã®è¡¨ç¤º
  return ch || "";
}

// ä¸»äººå…¬åãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ç¾åœ¨è¨­å®šã«å±•é–‹
function resolveInlineVars(s) {
  return String(s || "")
    .replaceAll("{MC}", profile.given)                              // åå‰ã®ã¿
    .replaceAll("{MC_FULL}", `${profile.family} ${profile.given}`)  // å§“ + å
    .replaceAll("{MC_FAMILY}", profile.family);                     // å§“ã®ã¿
}

//èƒŒæ™¯ç”»åƒã‚’assets/bg/bg_<sceneId>.png ã§çµ±ä¸€çš„ã«èª­ã¿è¾¼ã‚€
function setBG() {
  const bg = el("bg");
  const url = `assets/bg/bg_${state.sceneId}.png`;
  bg.style.backgroundImage = `url("${url}")`;
}

// ã‚­ãƒ£ãƒ©å â†’ ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã‚­ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
// ã‚­ãƒ£ãƒ©å â†’ ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã‚­ãƒ¼ï¼ˆJSONã®è¡¨è¨˜ã«åˆã‚ã›ã¦â€œåå‰ã®ã¿â€ã§ãƒãƒƒãƒ—ï¼‰
const CHAR_MAP = {
  "é™½ç¿”": "haruto",
  "ç…Œ": "koh",
  "æ¶¼å¼¥": "ryoya",
  "æ€œ": "rei",
  "å¸": "tsukasa",
  // ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§å‡ºã‚‹å°æœ¬ã‚‚æƒ³å®šã™ã‚‹ãªã‚‰äºˆå‚™ãƒãƒƒãƒ—ã‚’è¶³ã—ã¦OK:
  "ç¥è°· é™½ç¿”": "haruto",
  "æ°´ç„¡æœˆ ç…Œ": "koh",
  "å¤©ç¾½ æ¶¼å¼¥": "ryoya",
  "æ°·å ‚ æ€œ": "rei",
  "ä¹æ¡ å¸": "tsukasa"
};

// ç«‹ã¡çµµï¼ˆstandingï¼‰ï¼†ã‚¤ãƒ™ãƒ³ãƒˆCGï¼ˆeventï¼‰å¯¾å¿œã®èª­è¾¼
function setChar(ch, emo) {
  const img = el("char-img");
  // ä¸»äººå…¬ã¯ç«‹ã¡çµµãªã—ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã§å·®ã—æ›¿ãˆï¼‰
  if (!ch || ch === "ä¸»äººå…¬") { img.src = ""; img.alt = ""; return; }

  // å°æœ¬ä¸Šã®è¡¨è¨˜ï¼ˆé™½ç¿” / å¸ / â€¦ï¼‰â†’ è‹±æ•°å­—ã‚­ãƒ¼ï¼ˆharuto / tsukasa / â€¦ï¼‰
  const key = CHAR_MAP[ch] || ch; // æœªå®šç¾©ãªã‚‰ãã®ã¾ã¾ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

  let src = "";

  if (typeof emo === "string" && emo.startsWith("event:")) {
    // ã‚¤ãƒ™ãƒ³ãƒˆCGï¼šemo ã« "event:kiss01" ã®ã‚ˆã†ã«æ›¸ã
    const slug = emo.slice("event:".length).trim();
    src = `assets/celest/${key}/event/${slug}.png`;

      // â–¼ ã‚¹ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã‚¢ãƒ«ãƒãƒ ç™»éŒ²ï¼ˆé‡è¤‡å›é¿ï¼‰
        const tag = `${key}:${slug}`;
        if (!state.seenStills.includes(tag)) {
          state.seenStills.push(tag);
          save();
        }

} else {
    // ç«‹ã¡çµµï¼šemo ãŒç„¡ã‘ã‚Œã° normal ã‚’ä½¿ã†
    const pose = emo || "normal";
    src = `assets/celest/${key}/standing/${pose}.png`;
  }

  img.src = src;
  img.alt = `${ch} ${emo || "normal"}`;
}

function updateHUD(pulse = false) {
  // å·¦ä¸Šã®æ–°UIï¼ˆâ™¥ï¼‹ï¼…ï¼‰ã‚’æç”»
  updateAffDebug();

  // ãƒ‘ãƒ«ã‚¹æ¼”å‡ºã¯å¾“æ¥ã©ãŠã‚Š
  const hud = document.getElementById("hud");
  if (pulse && hud) {
    hud.classList.remove("pulse");
    void hud.offsetWidth;
    hud.classList.add("pulse");
  }
}

function flashBG() {
  const bg = el("bg");
  bg.style.opacity = "0.6";
  setTimeout(()=> bg.style.opacity = "1", 100);
}

// å¥½æ„Ÿåº¦å®Ÿå€¤ï¼ˆæ•´æ•°â™¥ã¨éƒ¨åˆ†ï¼…ï¼‰â†’ è¡¨ç¤ºç”¨ 0ã€œ100 ã«åˆæˆ
function affPctKey(key){
  const int  = (state.affection?.[key] ?? 0);   // 0..4 ï¼ˆãƒ™ãƒ¼ã‚¹â™¥1ã¯heartsUIå´ã§ä»˜ä¸ï¼‰
  const fine = (state.affFine?.[key] ?? 0);     // 0..100ï¼ˆæ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼‰
  const total = int * 20 + Math.round(fine * 0.2); // ä¾‹ï¼šâ™¥2ï¼‹50% â†’ 40 + 10 = 50
  return Math.max(0, Math.min(100, total));
}

// å·¦ä¸Šãƒ‡ãƒãƒƒã‚°å¥½æ„Ÿåº¦ï¼ˆé™½ç¿”/å¸ï¼‰ã‚’æ›´æ–°â†“â†“â†“ã“ã“ã‹ã‚‰
function updateAffDebug(){
  const wrap = document.getElementById("aff-debug");
  if(!wrap) return;

  const harutoUI  = heartMeterFor("haruto");   // Status ã¨åŒã˜é–¢æ•°ã‚’åˆ©ç”¨
  const tsukasaUI = heartMeterFor("tsukasa");

  wrap.innerHTML = `
    <div class="dbg-title">ğŸ’–å¥½æ„Ÿåº¦ãƒ‡ãƒãƒƒã‚°ç”¨<br>ï¼ˆãƒ—ãƒ­ãƒˆç‰ˆã®ã¿ï¼‰</div>
    <div class="row"><div class="who">é™½ç¿”</div>${harutoUI}</div>
    <div class="row"><div class="who">å¸</div>${tsukasaUI}</div>
  `;

  // Status ã¨åŒã˜ãã€Œãƒãƒ¼ã‚’ data-w% ã¾ã§ã‚¢ãƒ‹ãƒ¡ã•ã›ã‚‹ã€å‡¦ç†ã‚’å®Ÿè¡Œ
  wrap.querySelectorAll(".ht-bar .fill").forEach(el=>{
    const w = el.getAttribute("data-w") || "0";
    el.style.width = "0%";
    requestAnimationFrame(()=> 
      requestAnimationFrame(()=> el.style.width = w + "%")
    );
  });
}
// å·¦ä¸Šãƒ‡ãƒãƒƒã‚°å¥½æ„Ÿåº¦ï¼ˆé™½ç¿”/å¸ï¼‰ã‚’æ›´æ–°â†‘â†‘â†‘ã“ã“ã¾ã§


// ------- Typewriter --------
let tw = { timer: 0, running: false, full: "", i: 0 };
function textSpeedMs() {
  switch (settings.textSpeed) {
    case "instant": return 0;
    case "slow":    return 35;
    default:        return 20; // normal
  }
}
function startTypewriter(targetEl, fullText) {
  clearInterval(tw.timer);
  const withBreaks = fullText.replace(/\n/g, "<br>");  // æ”¹è¡Œã‚’ <br> ã«å¤‰æ›
  tw = { timer: 0, running: true, full: withBreaks, i: 0 }; // â† fullã‚’withBreaksã«
  const step = textSpeedMs();
  if (step === 0) {
    targetEl.innerHTML = withBreaks;  // â† innerHTMLã«ç›´æ¥å‡ºåŠ›
    tw.running = false;
    setNextButtonLabel(); // é€šå¸¸ãƒ©ãƒ™ãƒ«ã¸
    return;
  }
  targetEl.textContent = "";
  setSkipButtonLabel(); // ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½è¡¨ç¤º
  tw.timer = setInterval(() => {
    if (tw.i >= tw.full.length) {
      clearInterval(tw.timer);
      tw.running = false;
      setNextButtonLabel();
      return;
    }
    tw.i++;
    targetEl.innerHTML = tw.full.slice(0, tw.i); // innerHTML ã§å‡ºåŠ›
  }, step);
}
function skipTypewriterIfRunning(targetEl) {
  if (!tw.running) return false;
  clearInterval(tw.timer);
  targetEl.innerHTML = tw.full;  // â† innerHTML ã‚’ä½¿ã†
  tw.running = false;
  setNextButtonLabel();
  return true;
}

//ãƒ©ãƒ™ãƒ«åˆ‡æ›¿é–¢æ•°ã®å¯¾å¿œã€€ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ã®ã€Œâ–¶ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼æ¬¡ã¸ã€ãƒ©ãƒ™ãƒ«åˆ‡æ›¿ã¯ #btn-next å‰æãªã®ã§ã€#btn-go ã‚‚å¯¾è±¡ã«
function setSkipButtonLabel(){
  const b = el("btn-next") || el("btn-go");
  if (b) b.textContent = "â–¶ï¸ ã‚¹ã‚­ãƒƒãƒ—";
}
function setNextButtonLabel(){
  const b = el("btn-next") || el("btn-go");
  if (b) b.textContent = "æ¬¡ã¸";
}

//JSï¼šãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã„ã¦ãŸã‚‰é€²è¡Œã—ãªã„ã‚¬ãƒ¼ãƒ‰â†“â†“â†“ã“ã“ã‹ã‚‰
// ã„ãšã‚Œã‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã‹ï¼Ÿ
function anyModalOpen(){
  return !!document.querySelector('.modal:not(.hidden)');
}

// é€²è¡Œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ¬¡ã¸ï¼‰
function advance(){
  // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯é€²è¡Œã—ãªã„
  if (anyModalOpen()) return;
  // é¸æŠè‚¢è¡¨ç¤ºä¸­ã¯ç„¡åŠ¹
  if(!el("choices").classList.contains("hidden")) return;
  next(); // æ—¢å­˜ã®é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨
}

// --- ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ã‚’è‡ªå‹•åŒæœŸï¼šé–‹ã„ã¦ã„ã‚Œã° modal-open ã‚’ä»˜ä¸ã€å…¨éƒ¨é–‰ã˜ã‚Œã°é™¤å» ---
(function modalOpenSync(){
  function sync(){
    const hasOpen = !!document.querySelector('.modal:not(.hidden)');
    document.body.classList.toggle('modal-open', hasOpen);
  }
  // åˆæœŸ & ç›£è¦–
  sync();
  const obs = new MutationObserver(sync);
  obs.observe(document.body, { subtree:true, attributes:true, attributeFilter:['class'] });

  // ã¾ã‚Œãªã‚±ãƒ¼ã‚¹ã®ä¿é™ºï¼ˆæç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°å·®ç•°ï¼‰
  window.addEventListener('focus', sync);
})();

//JSï¼šãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã„ã¦ãŸã‚‰é€²è¡Œã—ãªã„ã‚¬ãƒ¼ãƒ‰â†‘â†‘â†‘ã“ã“ã¾ã§

// ç”»é¢ä¸­ã‚¯ãƒªãƒƒã‚¯ã§é€²ã‚€ï¼ˆãƒœã‚¿ãƒ³ä»¥å¤–ã®ã‚¿ãƒƒãƒ—ã«é™å®šï¼‰
const sceneRoot = document.querySelector("#page-scene .scene");
sceneRoot.addEventListener("click", (e)=>{
  // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯ç„¡è¦–
  if (anyModalOpen()) return;

  const t = e.target;
  const isButton = t.closest("button");
  const inChoice = !el("choices").classList.contains("hidden");
  if(isButton || inChoice) return; // ãƒœã‚¿ãƒ³ãƒ»é¸æŠè‚¢ã¯é™¤å¤–
  advance();
});

// ãƒŸãƒ‹ãƒœã‚¿ãƒ³
el("btn-go").addEventListener("click", advance);

// â©æ—©é€ã‚Šï¼šã‚¬ãƒ¯ï¼ˆæŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘ãƒ†ã‚­ã‚¹ãƒˆé€Ÿåº¦ã‚’å³æ™‚ã«ï¼‰
let _ffOrigSpeed = null;
el("btn-ff").addEventListener("mousedown", ()=>{
  _ffOrigSpeed = settings.textSpeed;
  settings.textSpeed = "instant";
});
el("btn-ff").addEventListener("mouseup", ()=>{
  if(_ffOrigSpeed){ settings.textSpeed = _ffOrigSpeed; _ffOrigSpeed=null; }
});

// â–¶ï¸AUTOï¼šã‚¬ãƒ¯ï¼ˆON/OFFãƒˆã‚°ãƒ«ã§è‡ªå‹•é€²è¡Œï¼‰
let autoTimer = 0, autoOn = false;
function setAuto(on){
  window.__autoOn = !!on;         // â† ç¾åœ¨ã®AUTOçŠ¶æ…‹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨˜éŒ²
  autoOn = on;
  el("btn-auto").classList.toggle("active", autoOn);
  clearInterval(autoTimer);
  if(autoOn){
    autoTimer = setInterval(()=>{
      // é¸æŠè‚¢ãŒå‡ºãŸã‚‰åœæ­¢
      if(!el("choices").classList.contains("hidden")) { setAuto(false); return; }
      // ã‚¿ã‚¤ãƒ—ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—â†’è¡Œé€²
      if(skipTypewriterIfRunning(el("text"))){ /* ä¸€åº¦å…¨è¡¨ç¤ºã—ã¦ã‹ã‚‰ */ }
      else{ next(); }
    }, 900); // é–“éš”ã¯æš«å®š
  }
}
el("btn-auto").addEventListener("click", ()=> setAuto(!autoOn));

/* é¸æŠè‚¢ã‚’é¸ã‚“ã ã‚ã¨ã€Œæ±ºå®šã€ãƒœã‚¿ãƒ³ã§é·ç§»â†“â†“â†“ã“ã“ã‹ã‚‰ */
// ===== Choice with Confirm =====
const choiceList = document.getElementById("choices");
const confirmBtn   = document.getElementById("btn-confirm");
let selectedChoiceIndex = null;

// é¸æŠè‚¢ã®æç”»ãŒå§‹ã¾ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã‚“ã§ãã ã•ã„ï¼ˆæ—¢å­˜ã®ã€Œé¸æŠè‚¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã€å‡¦ç†ã®ä¸­ï¼‰
function enterChoiceMode(){
  selectedChoiceIndex = null;
  confirmBtn?.classList.remove("hidden");
  confirmBtn.disabled = true;
  el("choices").classList.remove("hidden");
  el("btn-confirm").classList.remove("hidden");
  el("textbox").classList.add("choice-mode");   // â˜… è¿½åŠ 

  // æ—¢å­˜: choiceList å†…ã« .btn ã§é¸æŠè‚¢ã‚’ä¸¦ã¹ã‚‹å‡¦ç†ã¯ãã®ã¾ã¾
  // ã“ã“ã§ã¯ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚¯ãƒªãƒƒã‚¯ã‚’æ‹¾ã„ã¾ã™
}
function exitChoiceMode(){
  el("choices").classList.add("hidden");
  el("btn-confirm").classList.add("hidden");
  el("textbox").classList.remove("choice-mode"); // â˜… è¿½åŠ 
}

// é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯ï¼ˆé¸ã³ç›´ã—å¯ï¼‰
choiceList?.addEventListener("click", (e)=>{
  const btn = e.target.closest(".btn");
  if (!btn) return;

  // ã™ã¹ã¦ã®é¸æŠè‚¢ã‹ã‚‰ active ã‚’å¤–ã—ã€ã“ã®ãƒœã‚¿ãƒ³ã ã‘ active
  choiceList.querySelectorAll(".btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  // è‡ªåˆ†ãŒä½•ç•ªç›®ã‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§ãˆã‚‹ï¼‰
  const buttons = Array.from(choiceList.querySelectorAll(".btn"));
  selectedChoiceIndex = buttons.indexOf(btn);

  // æ±ºå®šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
  confirmBtn.disabled = (selectedChoiceIndex < 0);
});

// æ±ºå®šã§ç¢ºå®šâ†’æ¬¡ã¸
confirmBtn?.addEventListener("click", ()=>{
  if (selectedChoiceIndex == null || selectedChoiceIndex < 0) return;

  const opts = window.currentChoiceOptions || [];
  const opt  = opts[selectedChoiceIndex];
  if (!opt) return;

  // ãƒ­ã‚°ï¼ˆé¸ã‚“ã é¸æŠè‚¢ã®IDï¼‰
  state.log.push(opt.id || "");

  // Backlog ç”¨ã«ã€Œé¸ã‚“ã é¸æŠè‚¢ã®æ–‡è¨€ã€ã‚’å±¥æ­´ã¸ç©ã‚€â†“â†“â†“
  if (opt.label) {
    state.history.push({
      type: "choice",
      txt: opt.label
      // å¿…è¦ãªã‚‰ id ã‚‚æ®‹ã™: id: opt.id || null
    });
  }
  // Backlog ç”¨ã«ã€Œé¸ã‚“ã é¸æŠè‚¢ã®æ–‡è¨€ã€ã‚’å±¥æ­´ã¸ç©ã‚€â†‘â†‘â†‘

  // ===== å¾“æ¥ã€Œé¸æŠç›´å¾Œã«ã‚„ã£ã¦ã„ãŸå‡¦ç†ã€ã‚’ã“ã“ã§å®Ÿè¡Œ =====
  if (opt.effects) {
    // åŠ¹æœã‚’é©ç”¨
    applyEffects(opt.effects);

    // é€†åŠ¹æœã‚’ä½œã£ã¦UNDOã«ç©ã‚€ï¼ˆaff.*ã ã‘ç¬¦å·åè»¢ï¼‰
    const inv = {};
      for (const k in opt.effects) {
        if (k.startsWith("aff.") || k.startsWith("affp.")) {
          const delta = parseInt(String(opt.effects[k] || "0"), 10) || 0;
          inv[k] = -delta; // ï¼…ã‚‚ãƒã‚¤ãƒŠã‚¹ã§æˆ»ã™ã€‚applyEffects ãŒç¹°ã‚Šä¸Šã’/ç¹°ã‚Šä¸‹ã’å‡¦ç†ã‚’é¢å€’ã¿ã¾ã™
        }
      }
    state.undoStack.push({ effects: inv });
  } else {
    // åŠ¹æœãªã—ã§ã‚‚1æ‰‹åˆ†ã¨ã—ã¦ç©ºã‚¨ãƒ³ãƒˆãƒªã‚’ç©ã‚€
    state.undoStack.push({ effects: null });
  }

  // ã€Œé¸æŠç›´å¾Œã®1è¡Œã¸é€²ã‚€ã€ã€Œãã®è¡Œã¯æˆ»ã‚Œãªã„å¢ƒç•Œã€ã«è¨­å®š
  state.cursor++;
  state.backLockAt = state.cursor;

  save();
  renderCurrent();   // æ¬¡ã®è¡Œã‚’æç”»

  // å¾Œç‰‡ä»˜ã‘
  confirmBtn.disabled = true;
  confirmBtn.classList.add("hidden");
  selectedChoiceIndex = null;

  // å‘Šç™½ã‚·ãƒ¼ãƒ³ç”¨
  if (opt.id && opt.id.startsWith("confess.")) {
    const who = opt.id.split(".")[1];      // "haruto" or "tsukasa"
    state.vars.confessTo = who;
    save();
  }


});

/* é¸æŠè‚¢ã‚’é¸ã‚“ã ã‚ã¨ã€Œæ±ºå®šã€ãƒœã‚¿ãƒ³ã§é·ç§»â†‘â†‘â†‘ã“ã“ã¾ã§ */

/** =========================
 *  Scene player
 *  ========================= */
function renderCurrent() {
  const scene = findScene(state.sceneId);
  const name = el("name");
  const text = el("text");
  const btnNext = el("btn-next") || el("btn-go");  // â† è¿½åŠ 
  const choices = el("choices");
  const backBtn = el("btn-backline");

  // â˜…è¿½åŠ ï¼šæœ€åˆã®ã‚·ãƒ¼ãƒ³ã®1ãƒšãƒ¼ã‚¸ç›®ã§ã¯å¿…ãšæˆ»ã‚‹ç¦æ­¢ã«ã™ã‚‹â†“â†“â†“ã“ã“ã‹ã‚‰
  //  ãƒ»sceneId ãŒ prologue_studio
  //  ãƒ»ã‚«ãƒ¼ã‚½ãƒ«ãŒ 0 è¡Œç›®
  //  ãƒ»ã¾ã å±¥æ­´ãŒç©ºï¼ˆï¼ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œï¼‰
  if (state.sceneId === "prologue_studio" &&
      state.cursor === 0 &&
      state.history.length === 0) {
    state.backLockAt = 0;
  }
  // â˜…è¿½åŠ ï¼šæœ€åˆã®ã‚·ãƒ¼ãƒ³ã®1ãƒšãƒ¼ã‚¸ç›®ã§ã¯å¿…ãšæˆ»ã‚‹ç¦æ­¢ã«ã™ã‚‹â†‘â†‘â†‘ã“ã“ã¾ã§

  // ãƒ­ãƒƒã‚¯ä¸­ã¯æˆ»ã‚Œãªã„ â†’ ç„¡åŠ¹åŒ–ï¼ˆéè¡¨ç¤ºã«ã—ãŸã‘ã‚Œã° hidden ã‚’ãƒˆã‚°ãƒ«ï¼‰
  const lock = (state.backLockAt != null && state.cursor === state.backLockAt);
  backBtn.disabled = lock;
  // backBtn.classList.toggle("hidden", lock); // â†ã€Œéš ã™ã€æ´¾ãªã‚‰ã“ã¡ã‚‰
  const textbox = document.querySelector(".textbox"); // â† è¿½åŠ ï¼ˆ.textbox å‚ç…§ï¼‰â€»é¸æŠè‚¢ç”»é¢ã¨é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚

  if (!scene) {
    name.innerHTML = "";
    text.textContent = "script_json ãŒæœªè¨­å®šã§ã™ï¼ˆã¾ãŸã¯ sceneId ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰";
    btnNext.classList.add("hidden");
    choices.classList.add("hidden");
    return;
  }

  setBG();
  updateHUD();

  const STORY_ORDER = ["prologue_studio", "prologue_studio_tsukasa", "confession"]; //ã€å°†æ¥ã‚­ãƒ£ãƒ©ãŒå¢—ãˆãŸã‚‰ã€‘nextAfterScene() ã‚’é…åˆ—ãƒ‰ãƒ©ã‚¤ãƒ–ã«ã™ã‚‹

  const i = state.cursor;
  // if (i >= scene.lines.length) { showResult(); return; } ã‚’â†“ã«ç½®ãæ›ãˆ
  if (i >= scene.lines.length) { nextAfterScene(); return; }
  const node = scene.lines[i];

  // è¿½åŠ ï¼šã‚·ãƒ¼ãƒ³é·ç§»ãƒãƒ–â†“â†“â†“ã“ã“ã‹ã‚‰
  function nextAfterScene() {
    if (state.sceneId === "prologue_studio") {
      // é™½ç¿”ã®æ¬¡ã¯å¸
      state.sceneId = "prologue_studio_tsukasa";
      state.cursor = 0;
      state.backLockAt = 0;      // å„ã‚·ãƒ¼ãƒ³æœ€åˆã®1ãƒšãƒ¼ã‚¸ã§ã¯â—€ï¸ãŒéè¡¨ç¤ºã«ãªã‚Šã€2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã¯è‡ªå‹•ã§å†è¡¨ç¤º
      save(); setBG(); renderCurrent();
      return;
    }
    if (state.sceneId === "prologue_studio_tsukasa") {
      // å¸ãŒçµ‚ã‚ã£ãŸã‚‰å‘Šç™½ã‚·ãƒ¼ãƒ³ã¸
      state.sceneId = "confession";
      state.cursor = 0;
      state.backLockAt = 0;      // å„ã‚·ãƒ¼ãƒ³æœ€åˆã®1ãƒšãƒ¼ã‚¸ã§ã¯â—€ï¸ãŒéè¡¨ç¤ºã«ãªã‚Šã€2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã¯è‡ªå‹•ã§å†è¡¨ç¤º
      save(); setBG(); renderCurrent();
      return;
    }
    // å‘Šç™½ã‚·ãƒ¼ãƒ³ãŒçµ‚ã‚ã£ãŸã‚‰çµæœ
    showResult();
  }
  // è¿½åŠ ï¼šã‚·ãƒ¼ãƒ³é·ç§»ãƒãƒ–â†‘â†‘â†‘ã“ã“ã¾ã§

  // reset
  btnNext.classList.remove("hidden");
  choices.classList.add("hidden");
  choices.innerHTML = "";

  // â˜… å¿µã®ãŸã‚æ±ºå®šãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã¦ç„¡åŠ¹åŒ–
  confirmBtn?.classList.add("hidden");
  confirmBtn.disabled = true;

  if (node.narrate != null) {
    textbox.classList.remove("choice-mode");   // è¿½åŠ ï¼ˆé¸æŠè‚¢ãƒ¢ãƒ¼ãƒ‰ã¨é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§åŒºåˆ¥ï¼‰
    name.innerHTML = "";
    const shown = resolveInlineVars(node.narrate);    // ç”»é¢è¡¨ç¤ºã¯å±•é–‹
    startTypewriter(text, shown);
    state.history.push({ type: "narrate", txt: node.narrate }); // å±¥æ­´ã¯æœªå±•é–‹ã§ä¿å­˜
    save();
    setChar("", "");
  } else if (node.say) {
    textbox.classList.remove("choice-mode");   // è¿½åŠ ï¼ˆé¸æŠè‚¢ãƒ¢ãƒ¼ãƒ‰ã¨é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§åŒºåˆ¥ï¼‰
    const { ch, emo, txt } = node.say;
    name.innerHTML = renderNameLabel(ch);

    const shown = resolveInlineVars(txt || "");       // ç”»é¢è¡¨ç¤ºã¯å±•é–‹
    startTypewriter(text, shown);

    const isMC = (ch === "ä¸»äººå…¬");
    const displayCh = isMC ? profile.given : ch;  // Logã®ç™ºè¨€è€…åã¯â€œåã®ã¿â€ã§OK
    state.history.push({ type: "say", ch: displayCh, txt: txt || "", mc: isMC });

    save();
    setChar(ch, emo);
  }

   else if (node.choice) {
    textbox.classList.add("choice-mode");   // â† è¿½åŠ ï¼ˆé¸æŠè‚¢ãƒ¢ãƒ¼ãƒ‰ã¨é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åŒºåˆ¥ï¼‰
    name.innerHTML = "";
    text.textContent = "â€»é¸æŠè‚¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œæ±ºå®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ã€Œâ—€ï¸ã€ãƒœã‚¿ãƒ³ã§ç›´å‰ã®ä¼šè©±ã‚’ç¢ºèªã§ãã¾ã™ã€‚";
    btnNext.classList.add("hidden");
    choices.classList.remove("hidden");
    flashBG();

    // â˜… æ±ºå®šæ™‚ã«å‚ç…§ã™ã‚‹ãŸã‚ã€é…åˆ—ã‚’é€€é¿
    window.currentChoiceOptions = node.choice;

    node.choice.forEach(opt => {
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = opt.label || "(é¸æŠè‚¢)";
      choices.appendChild(b);
    });
    enterChoiceMode();   // â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆæ±ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼†ç„¡åŠ¹åŒ–ã§åˆæœŸåŒ–ï¼‰
    return;
  } else {
    state.cursor++; save(); renderCurrent(); return;
  }
}

/* applyEffects() ã‚’ã€Œaff.*ï¼ˆæ•´æ•°ï¼‰ã€ã€Œaffp.*ï¼ˆï¼…ï¼‰ã€ã®ä¸¡æ–¹ã«å¯¾å¿œâ†“â†“â†“ã“ã“ã‹ã‚‰ */

function applyEffects(effects) {
  if (!effects) return;

  for (const k of Object.keys(effects)) {
    const val = parseInt(String(effects[k] ?? "0"), 10) || 0;

    // â™¥ã®æ•´æ•°ï¼ˆ0..4 ã¾ã§å¢—ã‚„ã™å‰æã€‚heartsUIå´ã§ãƒ™ãƒ¼ã‚¹1ãŒç‚¹ç¯ï¼‰
    if (k.startsWith("aff.")) {
      const who = k.slice(4);
      if (state.affection[who] == null) state.affection[who] = 0;
      state.affection[who] = Math.max(0, Math.min(4, state.affection[who] + val));
    }

    // æ¬¡ã®â™¥ã¾ã§ã®ï¼…ï¼ˆ0..100ï¼‰
    if (k.startsWith("affp.")) {
      const who = k.slice(5);
      if (state.affFine[who] == null) state.affFine[who] = 0;

      let fine = state.affFine[who] + val;

      // æ­£æ–¹å‘ã®ç¹°ã‚Šä¸Šã’ï¼ˆMAX: â™¥5ï¼æ•´æ•°4ï¼‹100%ï¼‰
      while (fine >= 100 && state.affection[who] < 4) {
        state.affection[who] += 1;
        fine -= 100;
      }
      // é€†æ–¹å‘ï¼ˆï¼…ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸã‚‰å€Ÿã‚Šã‚‹ï¼‰
      while (fine < 0 && state.affection[who] > 0) {
        state.affection[who] -= 1;
        fine += 100;
      }
      // ã™ã§ã«â™¥ãŒæœ€å¤§ãªã‚‰ï¼…ã¯ 0..100 ã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆ100%ã§MAXæ¼”å‡ºï¼‰
      if (state.affection[who] >= 4) {
        fine = Math.max(0, Math.min(100, fine));
      }
      state.affFine[who] = Math.max(0, Math.min(100, fine));
    }
  }

  save();
  updateHUD(true);
  if (!el("status-modal").classList.contains("hidden")) renderStatus();
}
/* applyEffects() ã‚’ã€Œaff.*ï¼ˆæ•´æ•°ï¼‰ã€ã€Œaffp.*ï¼ˆï¼…ï¼‰ã€ã®ä¸¡æ–¹ã«å¯¾å¿œâ†‘â†‘â†‘ã“ã“ã¾ã§ */


function next() {
  // ã¾ãšã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ä¸­ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  if (skipTypewriterIfRunning(el("text"))) return;
  // ã“ã®å‰é€²è‡ªä½“ã«ã¯åŠ¹æœã¯ç„¡ã„ãŒã€æˆ»ã™å¯¾è±¡ã¨ã—ã¦ç©ºã‚¨ãƒ³ãƒˆãƒªã‚’ç©ã‚“ã§ãŠã
  state.undoStack.push({ effects: null });
  state.cursor++;
  save();
  renderCurrent();
}

function backOneLine() {
  if (skipTypewriterIfRunning(el("text"))) return;
  if (state.cursor <= 0) return;

  // â˜… é¸æŠç›´å¾Œã®1è¡Œï¼ˆãƒ­ãƒƒã‚¯ä½ç½®ï¼‰ã‹ã‚‰ã¯æˆ»ã‚Œãªã„
  if (state.backLockAt != null && state.cursor === state.backLockAt) {
    return; // ä½•ã‚‚ã—ãªã„ï¼ˆç„¡åŠ¹ï¼‰
  }

  // ç›´å‰ã®å‰é€²ã«å¯¾å¿œã™ã‚‹UNDOã‚’å–å¾—
  const last = state.undoStack.pop() || null;
  if (last && last.effects) {
    applyEffects(last.effects); // é€†åŠ¹æœã‚’é©ç”¨ï¼ˆå¥½æ„Ÿåº¦ã‚’æˆ»ã™ç­‰ï¼‰
  }

  state.cursor = Math.max(0, state.cursor - 1);
  save();
  renderCurrent();
}
el("btn-backline").addEventListener("click", backOneLine);

// === ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨AUTOã®æ©‹æ¸¡ã—â†“â†“â†“ã“ã“ã‹ã‚‰ ===
// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ãŸã‚‰ï¼šAUTOã‚’ä¸€æ™‚åœæ­¢ï¼ˆå…ƒãŒONãªã‚‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼‰
// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸã‚‰ï¼šãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚Œã°AUTOã‚’å†é–‹
(function(){
  let autoPausedByModal = false;

  function sync(){
    const open = anyModalOpen();
    if (open) {
      if (window.__autoOn && !autoPausedByModal) {
        autoPausedByModal = true;   // ã€Œå…ƒã€…ONã ã£ãŸã€ã‚’è¨˜éŒ²
        try { setAuto(false); } catch(e){}
      }
    } else {
      if (autoPausedByModal) {
        autoPausedByModal = false;
        try { setAuto(true); } catch(e){}
      }
    }
  }

  // åˆæœŸçŠ¶æ…‹ã§ã‚‚ä¸€åº¦åˆ¤å®š
  sync();

  // .modal è¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆhiddenã‚¯ãƒ©ã‚¹å¤‰åŒ–ï¼‰ã‚’ç›£è¦–
  const obs = new MutationObserver(sync);
  obs.observe(document.body, { subtree:true, attributes:true, attributeFilter:['class'] });

  // å¿µã®ãŸã‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤‰åŒ–ã§ã‚‚åŒæœŸï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã®æç”»ãƒ©ã‚°å¯¾ç­–ï¼‰
  window.addEventListener('focus', sync);
})();
// === ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨AUTOã®æ©‹æ¸¡ã—â†‘â†‘â†‘ã“ã“ã¾ã§ ===


/** =========================
 *  Result
 *  ========================= */
function showResult() {
  showPage("result");
  setAuto(false);

  const who = state.vars.confessTo || "haruto"; // "haruto" or "tsukasa"
  const aff = state.affection[who] ?? 0;

  // 1) ã‚¨ãƒ³ãƒ‰ç¨®åˆ¥ã¨æœ¬æ–‡
  let endTitle = "";
  let body = "";
  if (aff >= 4) {
    endTitle = "ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰";
    body = "é¸ã‚“ã ãã®æ‰‹ã‚’ã€å½¼ã¯ã¾ã£ã™ãå—ã‘å–ã£ã¦ãã‚ŒãŸã€‚";
  } else if (aff >= 3) {
    endTitle = "ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰";
    body = "æƒ³ã„ã¯å±Šãã¯ã˜ã‚ã¦ã„ã‚‹ã€‚æ¬¡ã®ä¸€æ­©ã¯ã€ãã£ã¨ä¸€ç·’ã«ã€‚";
  } else {
    endTitle = "ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰";
    body = "ã¾ã é‡ãªã‚‹é¼“å‹•ã¯å°ã•ã„ã€‚ã“ã‚Œã‹ã‚‰è‚²ã¦ã¦ã„ã‘ã°ã„ã„ã€‚";
  }

  // 2) å‘Šç™½ç›¸æ‰‹ã®è¡¨ç¤ºå
  const whoLabel = (who === "haruto") ? "é™½ç¿”" : "å¸";

  // 3) å¥½æ„Ÿåº¦ä¸€è¦§ï¼ˆç¸¦ä¸¦ã³ï¼‰
  const affList = `é™½ç¿”:${state.affection.haruto || 0}
å¸:${state.affection.tsukasa || 0}`;

  // 4) åæ˜ 
  const rt = document.getElementById("result-title");
  const tx = document.getElementById("result-text");
  const tg = document.getElementById("result-target");
  const al = document.getElementById("result-aff-list");

  if (rt) rt.textContent = `çµæœ ã€${endTitle}ã€‘`;
  if (tx) tx.textContent = body;
  if (tg) tg.textContent = whoLabel;
  if (al) al.textContent = affList;
}


/** =========================
 *  Title / Settings handlers
 *  ========================= */

if (new URLSearchParams(location.search).has('debug')) {
// New Game â†’ ã¾ãšé–‹å§‹ã‚­ãƒ£ãƒ©ã‚’é¸ã¶ï¼ˆãƒ‡ãƒãƒƒã‚°é™å®šUIï¼‰
el("btn-new").addEventListener("click", () => {
  // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰å¼¾ãï¼ˆé¸æŠå‰ã«æ°—ã¥ã‘ã‚‹ã‚ˆã†ã«ï¼‰
  if (!parseScript()) { 
    alert("å…ˆã« script_json ã‚’ Load ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  el("start-modal").classList.remove("hidden");
});
}

el("btn-continue").addEventListener("click", () => {
  if (!parseScript()) { alert("å…ˆã« script_json ã‚’ Load ã—ã¦ãã ã•ã„ã€‚"); return; }
  // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ã¾ã¾ Load ãƒ¢ãƒ¼ãƒ€ãƒ«ã ã‘é–‹ã
  openLoadModal("title");   // â˜… ã‚¿ã‚¤ãƒˆãƒ«ç”±æ¥ã¨ã—ã¦é–‹ãï¼ˆã€Œã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºã—åˆ†ã‘ç”¨ï¼‰
});

el("btn-back").addEventListener("click", () => showPage("title"));

el("btn-settings").addEventListener("click", () => {
  // ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
  el("inp-family").value = profile.family;
  el("inp-given").value = profile.given;
  el("sel-fontsize").value = settings.fontSize || defaultSettings.fontSize;
  el("sel-theme").value     = settings.theme    || defaultSettings.theme;
  el("sel-textspeed").value = settings.textSpeed|| defaultSettings.textSpeed;
  showPage("settings");
});

el("btn-cancel-settings").addEventListener("click", () => showPage("title"));
el("btn-save-settings").addEventListener("click", () => {
  const fam = el("inp-family").value.trim() || defaultProfile.family;
  const giv = el("inp-given").value.trim() || defaultProfile.given;
  profile.family = fam; profile.given = giv;
  saveProfile();

  // â–¼ æ–‡å­—ã‚µã‚¤ã‚ºã®ä¿å­˜ã¨é©ç”¨
  const fs = el("sel-fontsize").value;
  settings.fontSize = fs;
  settings.theme    = el("sel-theme").value;
  settings.textSpeed= el("sel-textspeed").value;
  saveSettings();
  applyFontSize();
  applyTheme();

  // é€²è¡Œä¸­ã®ä¼šè©±ã«ã‚‚å³åæ˜ ã—ãŸã„ã¨ãã¯å†æç”»
  if (!pages.scene.classList.contains("hidden")) {
    renderCurrent();
  }
  showPage("title");
});

/** =========================
 *  Script input
 *  ========================= */
el("btn-load").addEventListener("click", () => {
  script_json = el("script-input").value;
  const ok = parseScript();
  el("load-msg").textContent = ok ? "Loaded" : "JSON Parse Error";
});
el("btn-fill").addEventListener("click", () => {
  script_json = DEFAULT_SCRIPT;
  el("script-input").value = DEFAULT_SCRIPT;
  const ok = parseScript();
  el("load-msg").textContent = ok ? "Loaded (sample)" : "JSON Parse Error";
});

/** -------------------------
 *  Default sample script (assets/celest/<key>/standing/<pose>.png & assets/bg/bg_<sceneId>.png)
 *  ------------------------- */
const DEFAULT_SCRIPT = JSON.stringify({
  "scenes": [
    {
      "id": "prologue_studio",
      "lines": [
        {"narrate":"åˆã‚ã¦ã®åéŒ²ã€‚\nã‚ãŸã—ã®æ‰‹ã¯ã€å°‘ã—æ±—ã°ã‚“ã§ã„ãŸã€‚"},
        {"say":{"ch":"é™½ç¿”","emo":"normal","txt":"ã­ã‡ã€æ·±å‘¼å¸ã€‚å¤§ä¸ˆå¤«ã§ã—ã‚‡ï¼Ÿ"}},
        {"choice":[
          {"id":"00_haruto_1-a","label":"ã‚ã‚ŠãŒã¨ã†ã€‚å°‘ã—è½ã¡ç€ã„ãŸã‹ã‚‚ã€‚","effects":{"aff.haruto":"+1","affp.haruto":"+50"}},
          {"id":"00_haruto_1-b","label":"å¹³æ°—ã ã‚ˆã€‚â€¦ãŸã¶ã‚“ã€‚","effects":{"aff.haruto":"+1"}},
          {"id":"00_haruto_1-c","label":"æ·±å‘¼å¸ã—ãŸã‚‰è½ã¡ç€ã‘ã‚‹ã‹ãªï¼Ÿ"}
        ]},
        {"say":{"ch":"ä¸»äººå…¬","emo":"normal","txt":"æ¯ã‚’å¸ã£ã¦ã€åã„ã¦ã€‚ã†ã‚“ã€ã„ã‘ã‚‹ã€‚"}},
        {"say":{"ch":"é™½ç¿”","emo":"normal","txt":"{MC}ã€ã»ã‚‰ã€‚ã“ã“ã®å…¥ã‚Šã€å›ã®å£°ã§ç©ºæ°—ãŒå¤‰ã‚ã‚‹ã‹ã‚‰ã€‚"}},
        {"choice":[
          {"id":"00_haruto_2-a","label":"â€¦ä¿¡ã˜ã¦ã‚‹ã€‚ä»»ã›ã¦ã€‚","effects":{"aff.haruto":"+1","affp.haruto":"+50"}},
          {"id":"00_haruto_2-b","label":"ã†ã‚“ã€ã‚„ã£ã¦ã¿ã‚‹ã€‚","effects":{"aff.haruto":"+1"}},
          {"id":"00_haruto_2-c","label":"ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‹ã‘ãªã„ã§ã‚ˆâ€¦ï¼"}
        ]},
        {"narrate":"ã‚¹ã‚¿ã‚¸ã‚ªã®ãƒ©ã‚¤ãƒˆãŒã€å°‘ã—ã ã‘ã‚ãŸãŸã‹ãè¦‹ãˆãŸã€‚"}
      ]
    },
    {
      "id": "prologue_studio_tsukasa",
      "lines": [
      {"narrate":"åéŒ²å¾Œã¯ã€ãƒœãƒ¼ã‚«ãƒ«ãƒ¬ãƒƒã‚¹ãƒ³ã€‚"},
      {"narrate":"æ°—æŒã¡ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€é›†ä¸­ã—ã‚ˆã†ã€‚"},
      {"narrate":"è­œé¢å°ã®ä¸Šã€é»’ã„ã‚¤ãƒ³ã‚¯ãŒä¹¾ããã£ã¦ã„ãªã„ã€‚"},
        {"say":{"ch":"å¸","emo":"normal","txt":"â€¦ãŠã„ã€å‘¼å¸ãŒæµ…ã„ã€‚æœ€åˆã®äºŒæ‹ã€éŸ³ãŒç—©ã›ã‚‹ã ã‚ã€‚"}},
        {"choice":[
          {"id":"00_tsukasa_1-a","label":"ã‚ã‹ã£ãŸã€‚æ¬¡ã¯å¤§ä¸ˆå¤«ã€‚","effects":{"aff.tsukasa":"+1","affp.tsukasa":"+50"}},
          {"id":"00_tsukasa_1-b","label":"ã”ã‚ã‚“ã€‚ã‚„ã‚Šç›´ã™ã€‚","effects":{"aff.tsukasa":"+1"}},
          {"id":"00_tsukasa_1-c","label":"ç—©ã›ã¦ãªã„ã€‚â€¦ã¯ãšã€‚"}
        ]},
        {"say":{"ch":"å¸","emo":"normal","txt":"å£ã§è¨€ã†ã‚ˆã‚Šã€éŸ³ã§ç¤ºã›ã€‚â€¦ã§ãã‚‹ã ã‚ã€‚"}},
        {"choice":[
          {"id":"00_tsukasa_2-a","label":"ã§ãã‚‹ã€‚è´ã„ã¦ã¦ã€‚","effects":{"aff.tsukasa":"+1","affp.tsukasa":"+50"}},
          {"id":"00_tsukasa_2-b","label":"ã†ã‚“ã€ã‚„ã£ã¦ã¿ã‚‹ã€‚","effects":{"aff.tsukasa":"+1"}},
          {"id":"00_tsukasa_2-c","label":"â€¦ãŸã¶ã‚“ã€‚"}
        ]},
        {"narrate":"ãã®å£°ã¯ã€ã•ã£ãã‚ˆã‚Šã‚‚æ·±ãéŸ¿ã„ãŸã€‚â€¦ãã‚“ãªæ°—ãŒã—ãŸã€‚"}
      ]
    },
    {// DEFAULT_SCRIPT ã«å‘Šç™½ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ 
      "id": "confession",
      "lines": [
        {"narrate":"æº¢ã‚Œãã†ãªæ°—æŒã¡ã‚’ã€å½¼ã«ä¼ãˆãŸã„ã€‚"},
        {"choice":[
          {"id":"confess.haruto","label":"é™½ç¿”ã«å‘Šç™½ã™ã‚‹"},
          {"id":"confess.tsukasa","label":"å¸ã«å‘Šç™½ã™ã‚‹"}
        ]},
        {"narrate":"ã‚ãŸã—ã¯ã€æƒ³ã„ã‚’ä¼ãˆãŸã€‚"}
      ]
    }
  ]
}, null, 2);


// === èµ·å‹•æ™‚ã«åŸ‹ã‚è¾¼ã¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚»ãƒƒãƒˆã—ã¦å³ãƒ‘ãƒ¼ã‚¹ â†“â†“â†“ã“ã“ã‹ã‚‰ ===
script_json = DEFAULT_SCRIPT; //Paste script jsonã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å‡¦ç†
parseScript();

// ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚‚å…¥ã‚Œã¦ãŠã
const _si = document.getElementById("script-input");
if (_si) {
  _si.value = DEFAULT_SCRIPT;
  const msg = document.getElementById("load-msg");
  if (msg) msg.textContent = "Loaded (embedded)";
}

// èµ·å‹•æ™‚ã« Pasteæ¬„ã‚’åˆ¶å¾¡ï¼ˆ?debug ãŒã‚ã‚Œã°Pasteæ¬„ã‚’è¡¨ç¤ºï¼‰
const params = new URLSearchParams(location.search);
if (!params.has("debug")) {
  const pasteCard = document.getElementById("script-input")?.closest(".card");
  if (pasteCard) pasteCard.classList.add("hidden");
}

// === Pasteã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤ºï¼ˆãƒ—ãƒ­ãƒˆæ™‚ã®ã¿ï¼‰===
const _card = document.getElementById("script-input")?.closest(".card");
if (_card) _card.classList.add("hidden");

// === èµ·å‹•æ™‚ã«åŸ‹ã‚è¾¼ã¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚»ãƒƒãƒˆã—ã¦å³ãƒ‘ãƒ¼ã‚¹ â†‘â†‘â†‘ã“ã“ã¾ã§ ===


// init
showPage("title");



// ------ Backlog ------
function speakerLabelForLog(h) {
  // mc ãƒ•ãƒ©ã‚°ãŒç„¡ãã¦ã‚‚ ch==="ä¸»äººå…¬" ãªã‚‰ä¸»äººå…¬æ‰±ã„
  const isMC = (h.mc === true) || (h.ch === "ä¸»äººå…¬");
  return isMC ? profile.given : h.ch;  // ãƒ­ã‚°ã¯åã®ã¿ï¼ˆè‹—å­—ãªã—ï¼‰
}

function renderLog() {
  const box = el("log-list");
  box.innerHTML = "";
  if (!state.history.length) {
    box.innerHTML = `<div class="subtitle">ï¼ˆã¾ã å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
    return;
  }
  state.history.forEach(h => {
    const div = document.createElement("div");
    div.className = "list-item";

    if (h.type === "say") {
      const speaker = speakerLabelForLog(h);
      const body    = resolveInlineVars(h.txt);     // ã“ã“ã§ {MC} ã‚’æœ€æ–°åã«å±•é–‹
      div.innerHTML = `<div><strong>${speaker}</strong></div><div class="meta">${body}</div>`;
      } else if (h.type === "choice") {
      // â˜…è¿½åŠ ï¼šé¸æŠè‚¢è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆå…ˆé ­ã«â–¶ãªã©ä»˜ã‘ã¦ã‚‚ã‚ˆã„ï¼‰
        const body = resolveInlineVars(h.txt);
        div.innerHTML = `<div class="meta">â–¶ ${body}</div>`;
      } else { // narrate
        const body = resolveInlineVars(h.txt);
        div.innerHTML = `<div class="meta">â€” ${body}</div>`;
      }
    box.appendChild(div);
  });
}

// -----Logï¼ˆã‚¬ãƒ¼ãƒ‰ä»˜ãï¼‰----
const btnLog = el("btn-log");
if (btnLog) {
  btnLog.addEventListener("click", () => {
    renderLog();
    el("log-modal").classList.remove("hidden");
  });
}
el("btn-log-close").addEventListener("click", () =>
  el("log-modal").classList.add("hidden")
);


// ------ Album ------
function renderAlbum() {
  const box = el("album-list");
  box.innerHTML = "";
  if (!state.seenStills.length) {
    box.innerHTML = `<div class="subtitle">ï¼ˆè¡¨ç¤ºæ¸ˆã¿ã‚¹ãƒãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
    return;
  }
  // "haruto:kiss01" â†’ è¡¨ç¤ºåã«æ•´å½¢
  const prettyName = (tag) => {
    const [key, slug] = tag.split(":");
    // ã–ã£ãã‚Šè‹±æ•°å­—â†’æ—¥æœ¬èªåï¼ˆå¿…è¦ãªã‚‰è¾æ›¸ã‚’æ‹¡å……ï¼‰
    const rev = { haruto:"é™½ç¿”", koh:"ç…Œ", ryoya:"æ¶¼å¼¥", rei:"æ€œ", tsukasa:"å¸"};
    return `${rev[key] || key}ï¼š${slug}`;
  };
  state.seenStills.forEach(tag => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `<div><strong>${prettyName(tag)}</strong></div><div class="meta">${tag}</div>`;
    box.appendChild(div);
  });
}
el("btn-album").addEventListener("click", () => { renderAlbum(); el("album-modal").classList.remove("hidden"); });
el("btn-album-close").addEventListener("click", () => el("album-modal").classList.add("hidden"));


// About ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
el("btn-about").addEventListener("click", () => {
  el("about-modal").classList.remove("hidden");
});
el("btn-about-close").addEventListener("click", () => {
  el("about-modal").classList.add("hidden");
});

// ç‰ˆæ•°ã¯ã“ã“ã§ä¸€å…ƒç®¡ç†ï¼ˆç”³è«‹ã®ãŸã³ã«æ›¸ãæ›ãˆï¼‰
const APP_VERSION = "v0.1.0 (Demo)";
el("app-version").textContent = `Version: ${APP_VERSION}`;

// ===== æ¥½æ›²ãƒªã‚¹ãƒˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ =====
const TRACKS = [
  { id:"op_theme", title:"Value of Stars", unit:"CELEST", length:"3:08" },
  { id:"hr_ballad", title:"å›ã®å‘¼å¸", unit:"ç¥è°· é™½ç¿”", length:"3:15" },
  { id:"ts_midtempo", title:"ä½™ç™½", unit:"ä¹æ¡ å¸", length:"2:58" }
];
// å¿…è¦ã«ãªã£ãŸã‚‰ previewUrl ã‚’ assets/audio/*.mp3 ã§è¶³ã›ã¾ã™ï¼š{ previewUrl:"assets/audio/op_theme.mp3" }

let currentTrackIndex = 0;      // ä»®æƒ³çš„ãªã€Œå†ç”Ÿä¸­ã®æ›²ã€
let currentPlayMode   = "normal"; // "normal" | "shuffle" | "one" | "all"
let hasTrackSelection = false;    // æ›²ãƒªã‚¹ãƒˆã«ã€Œé¸æŠä¸­ã€ãŒã‚ã‚‹ã‹

//ç¾åœ¨å†ç”Ÿä¸­ã®æ›²æƒ…å ±ã‚’æ›´æ–°â†“â†“â†“ã“ã“ã‹ã‚‰
function updateNowPlayingUI() {
  const t = TRACKS[currentTrackIndex];
  if (!t) return;

  el("np-title").textContent  = t.title;
  el("np-artist").textContent = t.unit;

  const parts = (t.length || "0:00").split(":");
  const totalSec =
    Number(parts[0] || 0) * 60 +
    Number(parts[1] || 0);

  el("np-time-current").textContent = "0:00";
  el("np-time-total").textContent   = t.length || "0:00";

  const seek = el("np-seek");
  seek.min   = 0;
  seek.max   = totalSec;
  seek.value = 0;
  updateSeekFill(seek);   // â†è¿½åŠ ï¼ˆè‰²ã®ãƒªã‚»ãƒƒãƒˆï¼‰

}
//ç¾åœ¨å†ç”Ÿä¸­ã®æ›²æƒ…å ±ã‚’æ›´æ–°â†‘â†‘â†‘ã“ã“ã¾ã§

//æ¥½æ›²ãƒªã‚¹ãƒˆæç”»é–¢æ•°â†“â†“â†“ã“ã“ã‹ã‚‰
function highlightCurrentTrack() {
  const rows = document.querySelectorAll(".track-row");

  rows.forEach((row, i) => {
    const active = hasTrackSelection && i === currentTrackIndex;

    row.classList.toggle("is-active", active);

    // â–¶ ãƒœã‚¿ãƒ³ã®å…‰ã‚Šæ–¹
    const btn = row.querySelector(".track-play-btn");

    // æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ã®å¯¾è±¡
    const wave = row.querySelector(".track-wave");

    if (btn)  btn.classList.toggle("is-playing", active);

    if (wave) {
      wave.classList.add("show", "pulsing");
    } else {
      wave.classList.remove("show", "pulsing");
    }
  });
}


function renderTracks() {

  const box = el("tracks-list");
  if (!box) return;
  box.innerHTML = "";

  TRACKS.forEach((t, index) => {
    const row = document.createElement("div");
    row.className = "track-row";
    row.dataset.index = String(index);

    // è¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å…ˆé ­ã® â–¶ï¸ ã‚’å‰Šã‚‹
    const cleanTitle = t.title.replace(/^â–¶ï¸\s*/, ""); //æ¶ˆã—ãŸã‚‰å‹•ã‹ãªã„ã®ã§æ®‹ã™

    row.innerHTML = `
      <div class="track-number">${index + 1}</div>
      <div class="track-wave"></div>

      <button class="track-play-btn" data-index="${index}"
              aria-label="${cleanTitle} ã‚’å†ç”Ÿ">
        <span class="icon">â–¶</span>
      </button>

      <div class="track-info">
        <div class="track-title">${cleanTitle}</div>
        <div class="track-meta">${t.unit} ï¼ ${t.length}</div>
      </div>
    `;

    row.querySelector(".track-number").textContent = index + 1;

    box.appendChild(row);
  });

  highlightCurrentTrack();
}
//æ¥½æ›²ãƒªã‚¹ãƒˆæç”»é–¢æ•°â†‘â†‘â†‘ã“ã“ã¾ã§

//å†ç”Ÿãƒœã‚¿ãƒ³ãƒ»ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆâ†“â†“â†“ã“ã“ã‹ã‚‰
function flashPlayButton(btn) {
  if (!btn) return;
  btn.classList.remove("is-playing");
  // å†ä»˜ä¸ã®ãŸã‚ã® reflow
  void btn.offsetWidth;
  btn.classList.add("is-playing");
  setTimeout(() => btn.classList.remove("is-playing"), 260);
}

function attachTrackUIEvents() {
  const modal = el("tracks-modal");
  if (!modal) return;



    // å†ç”Ÿï¼ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«â†“â†“â†“ã“ã“ã‹ã‚‰
    const npToggle = el("np-toggle");
    if (npToggle) {
      // åˆæœŸçŠ¶æ…‹ã‚’ â–¶ ã«å¼·åˆ¶
      npToggle.textContent = "â–¶";

      npToggle.addEventListener("click", () => {
        const now = npToggle.textContent.trim();

        // â–¶ â†’ âšâš
        if (now === "â–¶") {
          npToggle.textContent = "âšâš";

            // â˜…è¿½åŠ ï¼šåˆå›å†ç”Ÿæ™‚ã«ãƒªã‚¹ãƒˆå´ã‚‚é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            if (!hasTrackSelection) {
              hasTrackSelection = true;
              // currentTrackIndex ã¯ 0 åˆæœŸå€¤ã®ã¾ã¾ã§OKï¼ˆValue of Starsï¼‰
              highlightCurrentTrack();
              updateNowPlayingUI();
            }
          }
        // âšâš â†’ â–¶
        else {
          npToggle.textContent = "â–¶";
          // åœæ­¢ã—ã¦ã‚‚é¸æŠçŠ¶æ…‹ã¯ç¶­æŒï¼ˆä»•æ§˜ã©ãŠã‚Šï¼‰
        }
      });
    }
    // å†ç”Ÿï¼ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«â†‘â†‘â†‘ã“ã“ã¾ã§

    // å†ç”Ÿãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆãƒˆã‚°ãƒ«å¼ï¼‰â€»shuffleï¼loop ã® ON/OFF ãƒˆã‚°ãƒ«ï¼ˆå†ã‚¯ãƒªãƒƒã‚¯ã§ OFFï¼‰â€»â†“â†“â†“ã“ã“ã‹ã‚‰
    document.querySelectorAll(".trk-mode-btn").forEach(btn => {
      btn.addEventListener("click", () => {

        const mode = btn.dataset.mode;

        // ã™ã§ã« active â†’ OFFï¼ˆè§£é™¤ï¼‰
        if (btn.classList.contains("is-active")) {
          btn.classList.remove("is-active");
          currentPlayMode = "normal";   // default çŠ¶æ…‹ã¸æˆ»ã™
          return;
        }

        // OFF ã®ã‚‚ã®ã‚’ ON ã«ã™ã‚‹
        currentPlayMode = mode;

        // ä»–ã®ãƒœã‚¿ãƒ³ã¯ OFF
        document.querySelectorAll(".trk-mode-btn").forEach(b =>
          b.classList.toggle("is-active", b === btn)
        );
      });
    });
    // å†ç”Ÿãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆãƒˆã‚°ãƒ«å¼ï¼‰â†‘â†‘â†‘ã“ã“ã¾ã§

  // å„æ›²ã®ã€Œâ–¶ã€ãƒœã‚¿ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
  modal.addEventListener("click", (e) => {
    // è¡Œå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚OK
    const row = e.target.closest(".track-row");
    if (!row) return;

    const idx = Number(row.dataset.index || "0");
    currentTrackIndex = idx;
    hasTrackSelection = true;          // ã“ã“ã§ã€Œé¸æŠã‚ã‚Šã€ã«ã™ã‚‹

    highlightCurrentTrack();
    updateNowPlayingUI();

    // æ¼”å‡ºç”¨ï¼šå·¦ã® â–¶ ãƒœã‚¿ãƒ³ã ã‘ã‚’å…‰ã‚‰ã›ã‚‹
    const playBtn = row.querySelector(".track-play-btn");
    flashPlayButton(playBtn);

    // å®Ÿéš›ã®éŸ³å£°å†ç”Ÿã¯æœªå®Ÿè£…ï¼ˆã‚¬ãƒ¯ã®ã¿ï¼‰
  });

}
//å†ç”Ÿãƒœã‚¿ãƒ³ãƒ»ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆâ†‘â†‘â†‘ã“ã“ã¾ã§

// ã‚¤ãƒ™ãƒ³ãƒˆ
el("btn-tracks").addEventListener("click", () => {
  renderTracks();
  el("tracks-modal").classList.remove("hidden");
});
el("btn-tracks-close").addEventListener("click", () => el("tracks-modal").classList.add("hidden"));
// åˆæœŸåŒ–ï¼ˆDOMæ§‹ç¯‰å¾Œã«1å›ã ã‘ï¼‰
attachTrackUIEvents();

el("btn-tracks-close").addEventListener("click", () => el("tracks-modal").classList.add("hidden"));

// ===== NFTï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ =====
const NFT_CONFIG = {
  name: "Offstage Love â€“ CELEST Cards",
  url: "#" // å¾Œã§ OpenSea ç­‰ã®URLã«å·®ã—æ›¿ãˆ
};
el("nft-collection-name").textContent = NFT_CONFIG.name;
el("nft-link").textContent = NFT_CONFIG.url === "#" ? "æº–å‚™ä¸­" : NFT_CONFIG.url;
el("nft-link").href = NFT_CONFIG.url;

el("btn-nft").addEventListener("click", () => el("nft-modal").classList.remove("hidden"));
el("btn-nft-close").addEventListener("click", () => el("nft-modal").classList.add("hidden"));

// Start Character Select modal handlersï¼ˆProto Onlyï¼‰
el("btn-start-haruto").addEventListener("click", () => {
  el("start-modal").classList.add("hidden");
  startGameAt("prologue_studio"); // é™½ç¿”
});
el("btn-start-tsukasa").addEventListener("click", () => {
  el("start-modal").classList.add("hidden");
  startGameAt("prologue_studio_tsukasa"); // å¸
});
el("btn-start-cancel").addEventListener("click", () => {
  el("start-modal").classList.add("hidden");
});

// ===== Quick Actions (ã‚¬ãƒ¯ã ã‘) =====â†“â†“â†“ã“ã“ã‹ã‚‰
(function(){
  const m  = el("qa-modal");
  const t  = el("qa-title");
  const b  = el("qa-body");
  const x  = el("qa-close");
  if(!m) return;

  function open(title, body){
    t.textContent = title;
    b.innerHTML   = body;
    m.classList.remove("hidden");
    document.body.classList.add("modal-open");  // â† èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢ï¼ˆä»»æ„ï¼‰
  }
  function close(){
    m.classList.add("hidden");
    document.body.classList.remove("modal-open");
  }

  x.addEventListener("click", close);
  m.addEventListener("click", (e)=>{ if(e.target === m) close(); });

  el("qa-shop").addEventListener("click", ()=>{
    open("ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ï¼ˆæº–å‚™ä¸­ï¼‰", "æœ‰å„Ÿãƒã‚¤ãƒ³ãƒˆã®è³¼å…¥ã¯æœ¬ç•ªã§å®Ÿè£…äºˆå®šã§ã™ã€‚");
  });
  el("qa-transfer").addEventListener("click", ()=>{
    open("æ©Ÿç¨®å¤‰æ›´ï¼ˆæº–å‚™ä¸­ï¼‰",
      "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½ã‚’ã“ã“ã«çµ±åˆäºˆå®šã§ã™ã€‚<br>â€»QR/ã‚³ãƒ¼ãƒ‰å…¥åŠ›UIã¯åˆ¥é€”å®Ÿè£…ã€‚");
  });
  el("qa-contact").addEventListener("click", ()=>{
    open("ãŠå•ã„åˆã‚ã›ï¼ˆæº–å‚™ä¸­ï¼‰",
      "FAQãƒ»ã”æ„è¦‹ãƒ»ä¸å…·åˆå ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ã‚’æœ¬ç•ªã§æ¥ç¶šäºˆå®šã§ã™ã€‚<br>å½“é¢ã¯ <a href='mailto:info@offstagelove.com'>info@offstagelove.com</a> ã¸ã€‚");
  });
})();

// ===== Quick Actions (ã‚¬ãƒ¯ã ã‘) =====â†‘â†‘â†‘ã“ã“ã¾ã§

// ===== Splash â†’ Start Screen é·ç§» =====â†“â†“â†“ã“ã“ã‹ã‚‰

(function(){
  const splash = document.getElementById("splash");
  const start  = document.getElementById("start-screen");
  if (!splash || !start) return;

  let tStart = null, tFade = null, skipped = false;  // â† ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å°‚ç”¨ã® keydown ãƒãƒ³ãƒ‰ãƒ©ã‚’å¤–ã›ã‚‹ã‚ˆã†ã«ä¿æŒ
  let keyHandler = null;

  function clearAll() {
    if (tStart) { clearTimeout(tStart); tStart = null; }
    if (tFade)  { clearTimeout(tFade);  tFade = null; }

    // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å°‚ç”¨ã‚­ãƒ¼å¾…ã¡ã‚’ç¢ºå®Ÿã«è§£é™¤
    if (keyHandler) {
      window.removeEventListener("keydown", keyHandler);
      keyHandler = null;
    }

  }
    function goDirectToTitle() {
    skipped = true;
    clearAll();                       // â† è‡ªå‹•é·ç§»ã‚’å®Œå…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    splash.classList.add("hidden");
    start.classList.add("hidden");
    showPage("title");
  }

  // 2.5ç§’å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã¸ï¼ˆâ€»ã‚¹ã‚­ãƒƒãƒ—æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
  tStart = setTimeout(() => {
    if (skipped) return;
    splash.classList.add("fadeout");
    tFade = setTimeout(() => {
      if (skipped) return;
      splash.classList.add("hidden");
      start.classList.remove("hidden");
      // ã“ã“ã«æ¥ãŸã‚‰ã€Œã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ä¸­ã® any-key ã§ã‚¿ã‚¤ãƒˆãƒ«ã¸ã€ã®å¾…æ©Ÿã¯ä¸è¦
      clearAll(); // ï¼ˆä¸Šã§ window ã® keydown ã‚‚å¤–ã‚Œã¾ã™ï¼‰
    }, 1000);
  }, 2500);

  // ã‚¹ã‚­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆonce ã§1å›ã ã‘ï¼‰
  splash.addEventListener("click", goDirectToTitle, { once: true });
  // window ã«å¼µã‚‹ãŒã€å¾Œã§ç¢ºå®Ÿã« remove ã§ãã‚‹ã‚ˆã†ã«å‚ç…§ã‚’ä¿æŒ
  keyHandler = () => goDirectToTitle();
  window.addEventListener("keydown", keyHandler, { once: true });

})();


// ===== Splash â†’ Start Screen é·ç§» =====â†‘â†‘â†‘ã“ã“ã¾ã§

// ===== Start Screen: Tap/Key ã§ã‚¿ã‚¤ãƒˆãƒ«ã¸ã€€â†“â†“â†“ã“ã“ã‹ã‚‰ =====
(function(){
  const start = document.getElementById("start-screen");
  if(!start) return;

    // â™ª â™« â™­ â™¯ ã®é™é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆè»½é‡ï¼‰
    (function makeNotes(){
      const layer = document.getElementById("notes-layer");
      if(!layer) return;

      const reduced = window.matchMedia &&
                      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      const chars   = ["â™ª","â™«","â™­","â™¯"];

      // ãƒ©ãƒ³ãƒ€ãƒ è‰²
      const colors  = [
        "#F09199", // æ¡œãƒ”ãƒ³ã‚¯
        "#F6B7B5", // ãƒ”ãƒ¼ãƒ
        "#F9D3C4", // ã‚µãƒ¼ãƒ¢ãƒ³
        "#FCE3B7", // æã‚¯ãƒªãƒ¼ãƒ 
        "#FFF2CC", // ãƒ¬ãƒ¢ãƒ³ã‚¯ãƒªãƒ¼ãƒ 
        "#FFFFFF"  // ç™½
      ];

      const isMobile = window.matchMedia("(max-width: 480px)").matches;
      const COUNT    = isMobile ? 16 : 24;

      for (let i = 0; i < COUNT; i++) {
        const sp = document.createElement("span");
        sp.textContent = chars[Math.floor(Math.random() * chars.length)];
        sp.style.color = colors[Math.floor(Math.random() * colors.length)]; // â˜…ã“ã“ã§è‰²ã‚’ä»˜ã‘ã‚‹

        const left  = Math.random() * 100;
        const size  = 14 + Math.random() * 10;
        const dur   = 14 + Math.random() * 10;   // â† ã‚†ã£ãã‚Šï¼ˆ14ã€œ24ç§’ï¼‰
        const delay = Math.random() * 6;

        sp.style.left = left + "%";
        sp.style.fontSize = size + "px";
        sp.style.setProperty("--dur",   dur   + "s");
        sp.style.setProperty("--delay", delay + "s");

        if (reduced) sp.style.animation = "none"; // ç”Ÿæˆã¯ã™ã‚‹ï¼ˆè¡¨ç¤ºã ã‘ï¼‰

        layer.appendChild(sp);
      }
    })();


  function enter(){
    // ãƒ•ã‚§ãƒ¼ãƒ‰â†’éè¡¨ç¤º
    start.classList.add("bye");
    setTimeout(()=> start.classList.add("hidden"), 320);
  }
  start.addEventListener("click", enter);
  window.addEventListener("keydown", enter, { once:true });

  // åˆæœŸãƒšãƒ¼ã‚¸ã¯æ—¢å­˜é€šã‚Š title ã‚’è¡¨ç¤ºã—ã¦OKï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãŒä¸Šã«è¦†ã†ï¼‰
  // showPage("title"); ã¯æ—¢ã«å‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã§å¤‰æ›´ä¸è¦
})();
// ===== Start Screen: Tap/Key ã§ã‚¿ã‚¤ãƒˆãƒ«ã¸ã€€â†‘â†‘â†‘ã“ã“ã¾ã§ =====

// ===== Tap Effect â†“â†“â†“ã“ã“ã‹ã‚‰=====
(function(){
  const chars  = ["â¤","â™¡","â˜…","â˜†","â™ª","â™«","â™¦","â™¢"];
  const colors = ["#F09199","#FFD6E0","#FFF","#C8E4FF","#FCE3B7"];

  document.addEventListener("click", (e)=>{
    //if(e.target.closest("button")) return; // ãƒœã‚¿ãƒ³ä¸Šã¯é™¤å¤–åˆ¶å¾¡ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã§ç„¡åŠ¹åŒ–ä¸­

    const count = 3; // æ•£ã‚‰ã™ç²’ã®æ•°
    for(let i=0; i<count; i++){
      const el = document.createElement("span");
      el.className = "tap-effect";
      el.textContent = chars[Math.floor(Math.random()*chars.length)];
      el.style.left = e.pageX + "px";
      el.style.top  = e.pageY + "px";
      el.style.color = colors[Math.floor(Math.random()*colors.length)];
      el.style.fontSize = (12 + Math.random()*10) + "px";

      // ãƒ©ãƒ³ãƒ€ãƒ æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ-40ã€œ40pxã®ç¯„å›²ï¼‰
      const angle = Math.random() * 2 * Math.PI;
      const dist  = 0 + Math.random()*30; // åŠå¾„40ã€œ70px
      const dx = Math.cos(angle) * dist + "px";
      const dy = Math.sin(angle) * dist + "px";
      el.style.setProperty("--dx", dx);
      el.style.setProperty("--dy", dy);

      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1200);
    }
  });
})();

// ===== Tap Effect â†‘â†‘â†‘ã“ã“ã¾ã§=====

// ===== Romantic Buttons attach â†“â†“â†“ã“ã“ã‹ã‚‰=====
(function(){
  // æ—¢å­˜ï¼†ä»Šå¾ŒDOMã«è¿½åŠ ã•ã‚Œã‚‹ .btn ã« â€œã‹ã‚ã„ã„ç‰ˆâ€ ã‚’ä»˜ä¸ã€‚
  // ãŸã ã—é™¤å¤–ã—ãŸã„ãƒœã‚¿ãƒ³ã¯ãã®ã¾ã¾ã«ã™ã‚‹ã€‚
  const EXCLUDE = new Set(["btn-ghost","btn-mini","qa-btn","btn-confirm"]);

  const apply = (el)=>{
    if (!el.classList || !el.classList.contains("btn")) return;
    for (const x of EXCLUDE) if (el.classList.contains(x)) return;
    el.classList.add("btn-romance");
  };

  // åˆæœŸ
  document.querySelectorAll(".btn").forEach(apply);

  // é€”ä¸­ç”Ÿæˆï¼ˆé¸æŠè‚¢ãªã©ï¼‰ã«ã‚‚é©ç”¨
  const obs = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(n=>{
        if(n.nodeType!==1) return;
        apply(n);
        n.querySelectorAll?.(".btn").forEach(apply);
      });
    });
  });
  obs.observe(document.body, { childList:true, subtree:true });
})();
// ===== Romantic Buttons attach â†‘â†‘â†‘ã“ã“ã¾ã§=====


// ==== NP SEEK & VOLUME SLIDER FILL â†“â†“â†“ã“ã“ã‹ã‚‰====
//æ³¨æ„ï¼šã“ã®åˆ¶å¾¡ã¯attachTrackUIEvents();ã‚ˆã‚Šå¾Œã«ç½®ãå¿…è¦ãŒã‚ã‚‹

// ======================
// â˜… ã“ã“ã‹ã‚‰ï¼šå…±é€šé–¢æ•° + åˆæœŸæç”» + ã‚¤ãƒ™ãƒ³ãƒˆ
// ======================

// å…±é€šï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è‰²ä»˜ã‘
function updateSeekFill(elm) {
  if (!elm) return;
  const pct = (elm.value / elm.max * 100) || 0;
  elm.style.setProperty("--seek-fill", pct + "%");
}

// åˆæœŸæç”»ï¼ˆHTML èª­ã¿è¾¼ã¿å¾Œï¼‰
document.addEventListener("DOMContentLoaded", () => {
  const seek  = document.getElementById("np-seek");
  const vol   = document.getElementById("np-volume");
  updateSeekFill(seek);
  updateSeekFill(vol);
});

// å†ç”Ÿä½ç½®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
// ç§’æ•° â†’ "m:ss" æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼â†“â†“â†“ã“ã“ã‹ã‚‰
function formatTime(sec) {
  sec = Math.max(0, Math.floor(Number(sec) || 0)); // æ•°å€¤ï¼†æ•´æ•°ã«æƒãˆã‚‹
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return m + ":" + String(s).padStart(2, "0");
}

// å†ç”Ÿä½ç½®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
const npSeek = document.getElementById("np-seek");
if (npSeek) {
  const npTimeCurrent = document.getElementById("np-time-current"); // å·¦å´ãƒ©ãƒ™ãƒ«

  npSeek.addEventListener("input", () => {
    // ãƒ”ãƒ³ã‚¯ã®å¡—ã‚Šéƒ¨åˆ†
    updateSeekFill(npSeek);

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä½ç½®ã«å¿œã˜ã¦ 0:00 â†’ m:ss ã‚’æ›´æ–°
    if (npTimeCurrent) {
      npTimeCurrent.textContent = formatTime(npSeek.value);
    }
  });
}
// ç§’æ•° â†’ "m:ss" æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼â†‘â†‘â†‘ã“ã“ã¾ã§

// éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
const npVol = document.getElementById("np-volume");
if (npVol) {
  npVol.addEventListener("input", () => {
    updateSeekFill(npVol);
  });
}

// ==== NP SEEK & VOLUME SLIDER FILL â†‘â†‘â†‘ã“ã“ã¾ã§====

// ==========================
// â˜… éŸ³é‡ãƒŸãƒ¥ãƒ¼ãƒˆã®åˆ¶å¾¡ã€€â†“â†“â†“ã“ã“ã‹ã‚‰
// ==========================

// å‰å›ã®éŸ³é‡ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®å¤‰æ•°
let lastVolume = 70;  // åˆæœŸå€¤ã¯é©å½“ã«ã€‚30ã§ã‚‚è‰¯ã„ã€‚

const volIcon = document.querySelector(".np-vol-icon");
const volSlider = document.getElementById("np-volume");

// ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒŸãƒ¥ãƒ¼ãƒˆï¼è§£é™¤
if (volIcon && volSlider) {
  volIcon.addEventListener("click", () => {

    const isMuted = volIcon.dataset.muted === "true";

    if (!isMuted) {
      // ---- ãƒŸãƒ¥ãƒ¼ãƒˆã«ã™ã‚‹ ----
      lastVolume = Number(volSlider.value);  // ç¾åœ¨ã®å€¤ã‚’ä¿å­˜
      volSlider.value = 0;                  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’0ã«
      updateSeekFill(volSlider);            // è‰²ã‚‚æ›´æ–°

      volIcon.textContent = "ğŸ”‡";           // ãƒŸãƒ¥ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã¸
      volIcon.dataset.muted = "true";
    } else {
      // ---- ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ ----
      volSlider.value = lastVolume;         // å‰ã®å€¤ã‚’å¾©å…ƒ
      updateSeekFill(volSlider);            // è‰²ã‚‚æ›´æ–°

      volIcon.textContent = "ğŸ”Š";           // å…ƒã®ã‚¢ã‚¤ã‚³ãƒ³ã¸
      volIcon.dataset.muted = "false";
    }
  });
}

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ã„ãŸã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚‚åŒæœŸã•ã›ã‚‹ï¼ˆ0ãªã‚‰è‡ªå‹•çš„ã«ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰
if (volSlider && volIcon) {
  volSlider.addEventListener("input", () => {
    const v = Number(volSlider.value);

    updateSeekFill(volSlider);  // è‰²æ›´æ–°

    if (v === 0) {
      volIcon.textContent = "ğŸ”‡";
      volIcon.dataset.muted = "true";
    } else {
      volIcon.textContent = "ğŸ”Š";
      volIcon.dataset.muted = "false";
      lastVolume = v;  // ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¦šãˆã¦ãŠã
    }
  });
}

// ==========================
// â˜… éŸ³é‡ãƒŸãƒ¥ãƒ¼ãƒˆã®åˆ¶å¾¡ã€€â†‘â†‘â†‘ã“ã“ã¾ã§
// ==========================
</script>

      <footer style="text-align: center;">
      <small>&copy; 2025 Offstage Love Project</small>
      </footer>

</body>
</html>



